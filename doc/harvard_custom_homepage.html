
<style>
    /* Custom CSS for the custom homepage... */
    .lite-header {font-weight: 300;}

    div.hmpg-action-block {padding-top:2em;}
    div.search-widget {padding-bottom: 2em;}
    div.browse-subjects {padding:0 2px;}
    div.browse-subjects a {color: #C55B28;}
    div.browse-subjects a:focus, div.browse-subjects a:hover {color: #9F3502;}
    div.hmpg-recent-col div.hmpg-recent-thumb img {max-height:48px;max-width:48px;}
    div.hmpg-recent-col div.hmpg-recent-thumb span {font-size:38px;}
    div.hmpg-activity-block .row .lite-header {margin-left:1em;}

    .btn-harvard { 
      color: #A51C30;
      background: #FFFFFF;
      font-weight: bold;
    }
    .btn-harvard:hover, 
    .btn-harvard:focus, 
    .btn-harvard:active, 
    .btn-harvard.active, 
    .open .dropdown-toggle.btn-harvard { 
      color: #7F000A;
      background: #FFFFFF;
      font-weight: bold;
    } 
</style>

<script>
    var baseUrl = "http://ec2-52-87-214-22.compute-1.amazonaws.com:8080";
    //var baseUrl = "http://localhost:8080";
    //var baseUrl = "https://dataverse.harvard.edu"
    
    //This get slow and eventually the resulting pile of substrings is too long if there are actually 1000 results
    //For this search to be valid the results returned will need to be higher than 1000 even
    var firstSearch = baseUrl + "/api/search?q=*&type=dataverse&per_page=1000";
    var secondSearch = baseUrl + "/api/search?q=*&type=dataset&sort=date&order=desc&per_page=";
    var thumbBaseURL = baseUrl + "/api/datasets/:persistentId/thumbnail" + "?persistentId=";
    var metricBaseUrl = baseUrl + "/api/info/metrics/";
    var simpleCatSearch = baseUrl + "/api/search?q=*&type=dataset&fq=categoryFromDataverse:";

    /**
    * Runs two search queries, the first to get dataverses based on a certain filter, and the second to get recent datasets for those dataverses.
    * The initial intent of the query is to get recent datasets based on dataverse subjects
    * @param {string} fqString - the filter for the first query, which returns which dataverses to get recent datasets from. For example: "&fq=dvCategory:(Journal%20OR%20Laboratory)" To get dataverses that are a Journal or Laboratory.
    * @param {number} resultCount - the number of results to write
    * @param {string} elm - The id of the html element to write the result to
    */
    function writeRecentDatasetsInDataversesTwoSearches(fqString, resultCount, elm) {
        var tempSecondSearch = secondSearch + resultCount;
        
        $.get(firstSearch + fqString, function(jData) {
            jData.data.items.forEach(function(item){
                tempSecondSearch += "&subtree=" + item.identifier;
            });

            $.get(tempSecondSearch, function(jData2) {
                var resultHtml = "";
                jData2.data.items.forEach(function(item){
                    resultHtml += "<div class=\"col-xs-12\">"
                    resultHtml += "<div class=\"col-xs-2 text-center hmpg-recent-thumb\"><a href=\"/dataset.xhtml?persistentId=" + item.global_id + "\" title=\"" + item.name + "\"><span class=\"icon-dataset\"></span></a></div>";
                    resultHtml += "<div class=\"col-xs-10\"><p><a href=\"/dataset.xhtml?persistentId=" + item.global_id + "\" title=\"" + item.name + "\">" + item.name + "</a></p><p class=\"small text-muted\">" + item.parentDataverse + " - " + item.publicationDate + "</p></div>";
                    resultHtml += "<hr class=\"col-xs-11 no-margin-top\"/></div>"
                });
                document.getElementById(elm).innerHTML = resultHtml;


                // BROKEN THUMBNAIL IMAGES
                // <img src=\"" + thumbBaseURL + item.global_id + "\" alt=\"Dataset thumbnail\">


            });
        });
    }
    
    function writeRecentDatasetsInDataverses(fqString, resultCount, elm) {
        $.get(simpleCatSearch + fqString + "&per_page=" + resultCount, function(jData) {
            var resultHtml = "";
            jData.data.items.forEach(function(item){
                resultHtml += "<div class=\"col-xs-12\">"
                resultHtml += "<div class=\"col-xs-2 text-center hmpg-recent-thumb\"><a href=\"/dataset.xhtml?persistentId=" + item.global_id + "\" title=\"" + item.name + "\"><span class=\"icon-dataset\"></span></a></div>";
                resultHtml += "<div class=\"col-xs-10\"><p><a href=\"/dataset.xhtml?persistentId=" + item.global_id + "\" title=\"" + item.name + "\">" + item.name + "</a></p><p class=\"small text-muted\">" + item.parentDataverse + " - " + item.published_at + "</p></div>";
                resultHtml += "<hr class=\"col-xs-11 no-margin-top\"/></div>"
            });
            document.getElementById(elm).innerHTML = resultHtml;
        });
        //curl "localhost:8080/api/search?q=*:*&fq=dvCategory:(Journal%20OR%20Laboratory)&type=dataset&per_page=1000"

    }
    
    function queryMetricSimple(metricRelPath, month, elm) {
        // $.get(metricBaseUrl + metricRelPath + month, function(jData) {
        //     document.getElementById(elm).innerHTML = JSON.stringify(jData);
        // });

        $.get(metricBaseUrl + metricRelPath + month, function(jData) {

            var resultCount = jData.data.count;

            document.getElementById(elm).innerHTML = resultCount;
        });
    }

    function querySubject(elm) {
        $.get(metricBaseUrl + "dataverses/bySubject", function(jData) {
            var subArray = [];

            var resultHtml = "";
            jData.data.forEach(function(item) {
                if(item.subject !== "N/A")
                subArray.push([item.subject, item.count]);
                
            });
            subArray.sort();
            subArray.forEach(function(subject){
                resultHtml += "<div class=\"browse-subjects\"><p><a href=\"/dataverse/root?q=&fq0=subject_ss%3A%22" + subject[0] + "%22&types=datasets&sort=dateSort&order=desc\" title=\"" + subject[0] + "\">" + subject[0] + "</a> <span class=\"text-muted\">" + subject[1] + "</span></p></div>";
            });
                
            document.getElementById(elm).innerHTML = resultHtml;
        });
    }

    //These calls are based on the old method for getting datasets by dataverse category, utilizing search
    //writeRecentDatasetsInDataversesTwoSearches("&fq=dvCategory:(Journal%20OR%20Laboratory)",3, "journals");
    //writeRecentDatasetsInDataversesTwoSearches("&fq=dvCategory:(\"Research+Project\"%20OR%20Researcher)",6, "researchers");   
    //writeRecentDatasetsInDataversesTwoSearches("" , 3, "journals", 12);
    //writeRecentDatasetsInDataversesTwoSearches("" , 6, "researchers", 6);
    
    writeRecentDatasetsInDataverses("(Journal)" , 3, "journals");
    writeRecentDatasetsInDataverses("(\"Research+Project\"%20OR%20Researcher)" , 3, "researchers");
    
    queryMetricSimple("datasets", "", "activityAllTimeDatasetsValue");
    queryMetricSimple("downloads", "", "activityAllTimeFilesValue");
    
    //These don't actually return the past 30 days, just the value up until September. Will need discussion
    queryMetricSimple("datasets/pastDays", "/30", "activity30DaysDatasetsValue");
    queryMetricSimple("downloads/pastDays", "/30", "activity30DaysFilesValue");
    
    querySubject("dataversesBySubject");
</script>

    <!-- ACTIONS -->
    <div class="row hmpg-action-block">
        <div class="col-xs-6">
            <div class="h4 lite-header">Deposit and share your data. Get academic credit.</div>
            <p class="text-muted small margin-bottom">Harvard Dataverse is a digital repository.</p>
            <button class="btn btn-default btn-harvard margin-top margin-bottom">
                Add data to Harvard Dataverse <span class="glyphicon glyphicon-plus"></span>
            </button>
        </div>
        <div class="col-xs-6">
            <div class="h4 lite-header">Organize datasets and gather metrics in your own virtual archive.</div>
            <p class="text-muted small margin-bottom">A dataverse is a virtual archive. A dataverse can contain dataverses, datasets, files and metadata.</p>
            <button class="btn btn-default btn-harvard margin-top margin-bottom">
                Create my own dataverse <span class="glyphicon glyphicon-chevron-right"></span>
            </button>
        </div>
    </div>

    <hr/>

    <!-- SEARCH + BROWSE + RECENT -->
    <div class="row hmpg-browse-block">
        
        <!-- SEARCH -->
        <div class="col-xs-12">
            <div class="h4 lite-header margin-bottom">Find data across research fields, preview metadata, and download files.</div>

            <div class="row">
                <div class="col-xs-4">
                    <div class="search-widget input-group">
                        <input id="inputDataverseSearch" class="form-control" type="text" placeholder="Search over 75,000 datasets..." onkeydown="if (event.keyCode == 13) document.getElementById('btnDataverseSearch').click();">
                        <span class="input-group-btn">
                            <button id="btnDataverseSearch" class="btn btn-default" type="button" onclick="window.location = '/dataverse/root?q=' + document.getElementById('inputDataverseSearch').value;return false;"><span class="glyphicon glyphicon-search"></span> Find</button>
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- BROWSE -->
        <div class="col-xs-12">
            <p class="text-muted small">Browse dataverses in this repository by subject.</p>
            <div class="row margin-bottom">
                <div id="dataversesBySubject" class="col-xs-12" style="-webkit-column-count: 3; -moz-column-count: 3; column-count: 3;">

                </div>
            </div>
        </div>

        <!-- RECENT -->
        <div class="col-xs-12">
            <div class="row">
                <div class="col-xs-6 hmpg-recent-col">
                    <div class="h4 lite-header margin-bottom">Datasets from journal articles</div>

                    <hr class="col-xs-11 no-margin-top"/>

                    <!-- JOURNAL RESULTS -->
                    <div id="journals" class="row col-xs-12">Loading...</div>

                    <!-- VIEW ALL -->
                    <div class="col-xs-12 text-center">
                        <p class="small text-muted"><a href="/dataverse/root?q=%28categoryFromDataverse%3A%22Journal%22%29&types=datasets&sort=dateSort&order=desc" title="All Datasets from Journals">ALL RECENT JOURNAL ACTIVITY</a> <span class="glyphicon glyphicon-chevron-right"></span></p>
                    </div>
                </div>

                <div class="col-xs-6 hmpg-recent-col">
                    <div class="h4 lite-header margin-bottom">Datasets from research projects, groups and researchers</div>

                    <hr class="col-xs-11 no-margin-top"/>

                    <!-- RESEARCHERS RESULTS -->
                    <div id="researchers" class="row col-xs-12">Loading...</div>

                    <!-- VIEW ALL -->
                    <div class="col-xs-12 text-center">
                        <p class="small text-muted"><a href= "/dataverse/root?q=%28categoryFromDataverse%3A%22Research+Project%22+OR+categoryFromDataverse%3A%22Researcher%22+OR+categoryFromDataverse%3A%22Research+Group%22%29&types=datasets&sort=dateSort&order=desc" title="All Datasets from Research Projects, Groups and Researchers">ALL RECENT RESEARCHERS ACTIVITY</a> <span class="glyphicon glyphicon-chevron-right"></span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <hr/>

    <!-- ACTIVITY -->
    <div class="row hmpg-activity-block">
        <div class="col-xs-12">
            <div class="h4 lite-header margin-bottom">Activity</div>
        </div>
        <div class="col-xs-12 row">
            <div class="col-xs-6">
                <p><span class="highlightBold">All Files</span> <span class="h4 lite-header" id="activityAllTimeDatasetsValue"></span> datasets added <span class="h4 lite-header" id="activityAllTimeFilesValue"></span> file downloads</p>
            </div>
            <div class="col-xs-6">
                <p><span class="highlightBold">Past 30 Days</span> <span class="h4 lite-header" id="activity30DaysDatasetsValue"></span> datasets added <span class="h4 lite-header" id="activity30DaysFilesValue"></span> file downloads</p>
            </div>
        </div>
    </div>

    <hr/>

    <!-- OTHER LINKS -->
    <div class="row hmpg-other-block">
        <div class="col-xs-12">
            <div class="h4 lite-header margin-bottom">Looking for other online repositories at Harvard?</div>
            <p class="text-muted"><a href="#" title="TITLE">Harvard DASH article repository</a> <span class="glyphicon glyphicon-chevron-right"></span> &nbsp; <a href="#" title="TITLE">All repositories at Harvard</a> <span class="glyphicon glyphicon-chevron-right"></span></p>
        </div>
    </div>
