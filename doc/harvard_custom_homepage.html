<!DOCTYPE html>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script>
    var baseUrl = "http://localhost:8080";
    //var baseUrl = "https://dataverse.harvard.edu"
    
    //This get slow and eventually the resulting pile of substrings is too long if there are actually 1000 results
    //For this search to be valid the results returned will need to be higher than 1000 even
    var firstSearch = baseUrl + "/api/search?q=*&type=dataverse&per_page=1000";
    var secondSearch = baseUrl + "/api/search?q=*&type=dataset&sort=date&order=desc&per_page=";
    var thumbBaseURL = baseUrl + "/api/datasets/:persistentId/thumbnail" + "?persistentId=";
    var metricBaseUrl = baseUrl + "/api/info/metrics/";
    
    function queryAndWrite(fqString, resultCount, elm) {
        var tempSecondSearch = secondSearch + resultCount;
        
        $.get(firstSearch + fqString, function(jData) {
            jData.data.items.forEach(function(item){
                tempSecondSearch += "&subtree=" + item.identifier;
            });

            $.get(tempSecondSearch, function(jData2) {
                var resultHtml = "";
                jData2.data.items.forEach(function(item){
                    resultHtml += "<img src=\""+thumbBaseURL + item.global_id+"\" >";
                    resultHtml += item.name +"<br>";
                });
                document.getElementById(elm).innerHTML = resultHtml;
            });
        });
    }
    
    function queryMetric(metricRelPath, month, elm) {
        $.get(metricBaseUrl+metricRelPath+month, function(jData) {
            document.getElementById(elm).innerHTML = JSON.stringify(jData);
        });
    }
    
    //These are the correct searches, but commented out as I don't have enough results
    //queryAndWrite("&fq=dvCategory:(Journal%20OR%20Laboratory)",3, "Journal");
    //queryAndWrite("&fq=dvCategory:(\"Research+Project\"%20OR%20Researcher)",6, "ResearchIndividual");
    
    queryAndWrite("" , 3, "Journal");
    queryAndWrite("" , 6, "ResearchIndividual");
    
    queryMetric("dataverses/bySubject", "", "dataversesBySubject");
    
    queryMetric("datasets/toMonth", "", "activityAllTimeDatasetsValue");
    queryMetric("files/toMonth", "", "activityAllTimeFilesValue");
    
    //These don't actually return the past 30 days, just the value up until September. Will need discussion
    queryMetric("datasets/toMonth", "/2018-09", "activity30DaysDatasetsValue");
    queryMetric("files/toMonth", "/2018-09", "activity30DaysFilesValue");

    
</script>

<html>
    <body>
        <div id="JournalHead"><b>Journal</b></div>
        <div id="Journal"></div>
        <div id="ResearchIndividualHead"><b>Research Project or Individual</b></div>
        <div id="ResearchIndividual"></div>
        <hr>
        <div id="dataversesBySubjectHead"><b>Dataverses By Subject</b></div>
        <div id="dataversesBySubject"></div>
        <hr>
        <div id="activityHead"><b><u>Activity</u></b></div>
        <div id="activityAllTimeHead"><b>All Time</b></div>
        <div id="activityAllTimeDatasets"> Datasets: <span id="activityAllTimeDatasetsValue"></span></div>
        <div id="activityAllTimeFiles"> Files: <span id="activityAllTimeFilesValue"></span></div>
        <div id="activity30DaysHead"><b>30 Days</b></div>
        <div id="activity30DaysDatasets"> Datasets: <span id="activity30DaysDatasetsValue"></span></div>
        <div id="activity30DaysFiles"> Files: <span id="activity30DaysFilesValue"></span></div>
    </body>
</html>