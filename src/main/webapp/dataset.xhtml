<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:p="http://primefaces.org/ui">

    <h:head>
    </h:head>

    <h:body>
        <ui:composition template="/dataverse_template.xhtml">
            <ui:param name="pageTitle" value="Dataset"/>
            <ui:param name="dataverse" value="#{DatasetPage.dataset.owner}"/>
            <ui:define name="body">

                <f:metadata>
                    <f:viewParam name="id" value="#{DatasetPage.dataset.id}"/>
                    <f:viewParam name="ownerId" value="#{DatasetPage.ownerId}"/>
                    <f:viewAction action="#{DatasetPage.init}" />
                </f:metadata>

                <h:form id="datasetForm">
                    <!-- Breadcrumbs Panel -->
                    <p:panel styleClass="panelLayoutBlock breadcrumbNavBlock" rendered="#{empty DatasetPage.editMode}">
                        <ui:repeat value="#{DatasetPage.dataset.owner.owners}" var="owner">
                            <h:outputLink value="/dataverse.xhtml?id=#{owner.id}">
                                <h:outputText value="#{owner.name} Dataverse"/>
                            </h:outputLink>
                            <h:outputText value=" > "/>
                        </ui:repeat>
                        <!--<br/>-->
                        <h:outputLink value="/dataverse.xhtml?id=#{DatasetPage.dataset.owner.id}">
                            <h:outputText value="#{DatasetPage.dataset.owner.name} Dataverse"/>
                        </h:outputLink>

                        <ui:fragment rendered="#{!empty DatasetPage.dataset.latestVersion.title}">
                            <h:outputText value=" > "/>
                            <h:outputText value="#{DatasetPage.dataset.latestVersion.title}" style="font-weight:bold;"/>
                        </ui:fragment>
                    </p:panel>

                    <!-- Message Panel -->
                    <p:panel styleClass="panelLayoutTitleBlock" rendered="#{!empty DatasetPage.editMode}">
                        <p:messages id="messages" showDetail="true" autoUpdate="true" closable="true"/>
                        <!--<h:outputText value="Upload your dataset:" rendered="#{DatasetPage.editMode == 'CREATE'}"/>-->
                        <!--<h:outputText value="Edit your dataset's information:" rendered="#{DatasetPage.editMode == 'INFO'}"/>-->
                        <!--<h:outputText value="Edit your dataset's files:" rendered="#{DatasetPage.editMode == 'FILE'}"/>-->
                        <!--<h:outputText value="Edit your dataset's metadata" rendered="#{DatasetPage.editMode == 'METADATA'}"/>-->
                    </p:panel>

                    <style type="text/css">
                        .panelgridLayoutTable .ui-datatable-tablewrapper thead {display:none;}
                    </style>
                    
                    <!-- Title / Button Panel -->
                    <p:panel styleClass="panelLayoutBlock">
                        <p:panelGrid styleClass="panelgridLayoutTable" columns="2" columnClasses="leftClass,rightClass" rendered="#{empty DatasetPage.editMode}">
                            <ui:fragment>
                                <h:outputText value="#{DatasetPage.dataset.latestVersion.title}" rendered="#{empty DatasetPage.editMode or !(DatasetPage.editMode == 'INFO' or DatasetPage.editMode == 'CREATE')}" style="display:block;font-size:1.25em;font-weight:bold;"/>

                                <h:outputText value="#{DatasetPage.datasetVersionUI.authorsStr}" rendered="#{empty DatasetPage.editMode or !(DatasetPage.editMode == 'INFO' or DatasetPage.editMode == 'CREATE')}" style="display:block; margin-bottom:.5em;" />

                        
                                <!--<h:outputText value="Data Citation: " style="display:block; margin-top:.5em;"/>-->
                                <p:panel style="background-color: #F5F5F5;">
                                    <h:outputText id="citationDisplay" value="#{DatasetPage.datasetVersionUI.citation}" escape="false"/>
                                </p:panel>
                                <!--<p:panel>
                                    <p:panelGrid columns="2">
                                        <p:commandButton value="Copy Citation" disabled="true"/>
                                        <h:outputLink onclick="PF('whyCite').show();" value="javascript:void(0)">
                                            <h:outputText value="Why cite?" style="color: green"/>
                                        </h:outputLink>
                                        <p:dialog header="Why cite?" widgetVar="whyCite" modal="true" height="100">
                                            <h:outputText value="Info on why to use a data citation."/>
                                        </p:dialog>
                                    </p:panelGrid>
                                </p:panel>-->
                            </ui:fragment>
                            <ui:fragment>
                                <p:panelGrid styleClass="panelgridLayoutTable" columns="2">
                                <!--<p:panelGrid styleClass="panelgridLayoutTable" columns="2" rendered="#{permissionServiceBean.on(DatasetPage.dataset.owner).canIssueCommand('DatasetCreate') and empty DatasetPage.editMode}">-->
                                    <p:panel styleClass="panelLayoutButtonBlock">
                                        <p:menuButton id="editDataSet" value="Edit Dataset" iconPos="right">
                                            <p:menuitem id="editFiles" value="Add/Edit Files" actionListener="#{DatasetPage.edit('FILE')}" update="@all">
                                                <f:setPropertyActionListener target="#{DatasetPage.selectedTabIndex}" value="0" />
                                            </p:menuitem>
                                            <p:menuitem id="editMetadata" value="Edit Metadata" actionListener="#{DatasetPage.edit('METADATA')}" update="@all">
                                                <f:setPropertyActionListener target="#{DatasetPage.selectedTabIndex}" value="0" />
                                            </p:menuitem>
                                            <p:menuitem value="Edit Permissions" disabled="true"/>
                                        </p:menuButton>
                                    </p:panel>
                                </p:panelGrid>
                            </ui:fragment>
                        </p:panelGrid>
                       <p:panelGrid styleClass="panelgridLayoutTable" columns="1">
                            <ui:fragment>
                                <p:panelGrid styleClass="panelgridFormTable" columns="2" rendered="#{DatasetPage.editMode == 'INFO' or DatasetPage.editMode == 'METADATA' or DatasetPage.editMode == 'CREATE'}">
                                    <ui:fragment>
                                    </ui:fragment>
                                    <ui:fragment>
                                        <h:outputText value="Host Dataverse"/>
                                    </ui:fragment>
                                    <ui:fragment>
                                        <p:selectOneMenu value="#{DatasetPage.ownerId}" filter="true" filterMatchMode="startsWith" effect="none">
                                            <f:selectItems value="#{dataverseServiceBean.findAll()}" var="dv" itemLabel="#{dv.name}" itemValue="#{dv.id}"/>
                                        </p:selectOneMenu>
                                    </ui:fragment>
                                </p:panelGrid>
                            </ui:fragment>
                        </p:panelGrid>
                        <ui:fragment>
                            <p:outputLabel value="Title " /> <h:outputText value="* " style="color: #B94A48;"/>
                            <h:outputText value=" #{DatasetPage.datasetVersionUI.title.strValue}" rendered="#{empty DatasetPage.editMode}"/>
                            <ui:fragment rendered="#{(DatasetPage.editMode == 'INFO' or DatasetPage.editMode == 'METADATA' or DatasetPage.editMode == 'CREATE') and !datasetFieldVal.datasetField.hasChildren}">
                                  <p:inputText id="input_Title" size="90" value="#{DatasetPage.datasetVersionUI.title.strValue}">
                                  </p:inputText>
                                  <p:watermark for="input_Title" value="Enter title..." />                                          
                                  <p:message for="input_Title"/>
                        </ui:fragment>
                        </ui:fragment>
                        
                        <ui:fragment>
                            <p:outputLabel value="Author(s)" /> <h:outputText value="* " style="color: #B94A48;"/>
                            <h:outputText value=" #{DatasetPage.datasetVersionUI.authorsStr}" rendered="#{empty DatasetPage.editMode}"/>
                            <ui:fragment rendered="#{(DatasetPage.editMode == 'INFO' or DatasetPage.editMode == 'METADATA' or DatasetPage.editMode == 'CREATE') and !datasetFieldVal.datasetField.hasChildren}">
                                <h:outputText value="Organization as Author(Single Name): " /> 
                                <p:selectBooleanCheckbox value="#{DatasetPage.authorAsOrg}" > 
                                     <p:ajax update="@all" />  
                                </p:selectBooleanCheckbox> 
                                <p:dataTable id="authorsTable" value="#{DatasetPage.datasetVersionUI.datasetAuthors}" var="author">
                                    <p:column>   
                                        <p:outputLabel value="First Name " rendered="#{!DatasetPage.authorAsOrg}" />
                                        <p:inputText id="firstName" value="#{author.firstName.strValue}" rendered="#{!DatasetPage.authorAsOrg}" />
                                        <p:message for="firstName"/>
                                    </p:column>
                                    <p:column>   
                                        <p:outputLabel value="Last Name " rendered="#{!DatasetPage.authorAsOrg}" />
                                        <p:outputLabel value="Organization Name " rendered="#{DatasetPage.authorAsOrg}" />
                                        <p:inputText id="lastName" value="#{author.lastName.strValue}" />
                                        <p:message for="lastName"/>
                                    </p:column>
                                    <p:column>
                                        <p:outputLabel value="Author Affiliation" />
                                        <p:inputText id="authorAffiliation" value="#{author.affiliation.strValue}" />
                                        <p:message for="authorAffiliation"/>
                                    </p:column>
                                    <p:column>
                                        <p:commandButton id="editFileButton" value="Add Author"  actionListener="#{DatasetPage.addRecord('AUTHOR')}" update="@all">
                                            <f:setPropertyActionListener target="#{DatasetPage.selectedTabIndex}" value="0" />
                                        </p:commandButton>
                                        <p:commandButton id="editMetadataButton" value="Delete Author"  actionListener="#{DatasetPage.addRecord('AUTHOR')}" update="@all">
                                            <f:setPropertyActionListener target="#{DatasetPage.selectedTabIndex}" value="0" />
                                        </p:commandButton>
                                    </p:column>
                                </p:dataTable>
                            </ui:fragment>
                        </ui:fragment>
                        <ui:fragment>
                            <p:outputLabel value="Description" /> 
                            <h:outputText value=" #{DatasetPage.datasetVersionUI.description.strValue}" rendered="#{empty DatasetPage.editMode}"/>
                            <ui:fragment rendered="#{(DatasetPage.editMode == 'INFO' or DatasetPage.editMode == 'METADATA' or DatasetPage.editMode == 'CREATE') and !datasetFieldVal.datasetField.hasChildren}">
                                        <p:inputText id="description" value="#{DatasetPage.datasetVersionUI.description.strValue}" /> 
                                        <p:message for="description"/>
                            </ui:fragment>
                        </ui:fragment>
                        
                        <ui:fragment>
                            <p:outputLabel value="Keyword(s)" /> 
                            <h:outputText value=" #{DatasetPage.datasetVersionUI.keywordsStr}" rendered="#{empty DatasetPage.editMode}"/>
                            <ui:fragment rendered="#{(DatasetPage.editMode == 'INFO' or DatasetPage.editMode == 'METADATA' or DatasetPage.editMode == 'CREATE') and !datasetFieldVal.datasetField.hasChildren}">
                                <p:dataTable id="keywordsTable" value="#{DatasetPage.datasetVersionUI.datasetKeywords}" var="keyword">
                                    <p:column>   
                                        <p:outputLabel value="Keyword " />
                                        <p:inputText id="keyword" value="#{keyword.value.strValue}" /> 
                                        <p:message for="keyword"/>
                                    </p:column>
                                    <p:column>
                                        <p:commandButton id="editFileButton" value="Add Keyword"  actionListener="#{DatasetPage.addRecord('KEYWORD')}" update="@all">
                                            <f:setPropertyActionListener target="#{DatasetPage.selectedTabIndex}" value="0" />
                                        </p:commandButton>
                                        <p:commandButton id="editMetadataButton" value="Delete Keyword"  actionListener="#{DatasetPage.addRecord('KEYWORD')}" update="@all">
                                            <f:setPropertyActionListener target="#{DatasetPage.selectedTabIndex}" value="0" />
                                        </p:commandButton>
                                    </p:column>
                                </p:dataTable>
                            </ui:fragment>
                        </ui:fragment>
                        
                        <ui:fragment>
                            <p:outputLabel value="Topic Classification" /> 
                            <h:outputText value=" #{DatasetPage.datasetVersionUI.topicClassStr}" rendered="#{empty DatasetPage.editMode}"/>
                            <ui:fragment rendered="#{(DatasetPage.editMode == 'INFO' or DatasetPage.editMode == 'METADATA' or DatasetPage.editMode == 'CREATE') and !datasetFieldVal.datasetField.hasChildren}">
                                <p:dataTable id="topicsTable" value="#{DatasetPage.datasetVersionUI.datasetTopicClasses}" var="topic">
                                    <p:column>   
                                        <p:outputLabel value="Topic Classification " />
                                        <p:inputText id="topic" value="#{topic.value.strValue}" /> 
                                        <p:message for="topic"/>
                                    </p:column>
                                    <p:column>   
                                        <p:outputLabel value="Contolled Vocabulary " />
                                        <p:inputText id="topicVocab" value="#{topic.vocab.strValue}" /> 
                                        <p:message for="topicVocab"/>
                                    </p:column>
                                   <p:column>   
                                        <p:outputLabel value="Contolled Vocabulary URI " />
                                        <p:inputText id="topicVocabURI" value="#{topic.vocabURI.strValue}" /> 
                                        <p:message for="topicVocabURI"/>
                                    </p:column>
                                    <p:column>
                                        <p:commandButton id="editFileButton" value="Add Topic"  actionListener="#{DatasetPage.addRecord('TOPIC')}" update="@all">
                                            <f:setPropertyActionListener target="#{DatasetPage.selectedTabIndex}" value="0" />
                                        </p:commandButton>
                                        <p:commandButton id="editMetadataButton" value="Delete Topic"  actionListener="#{DatasetPage.addRecord('TOPIC')}" update="@all">
                                            <f:setPropertyActionListener target="#{DatasetPage.selectedTabIndex}" value="0" />
                                        </p:commandButton>
                                    </p:column>
                                </p:dataTable>
                            </ui:fragment>
                        </ui:fragment>

                    </p:panel>

                    <p:panel id="content" styleClass="panelLayoutBlock" rendered="#{DatasetPage.editMode != 'INFO'}">
                        <p:tabView id="tabView" widgetVar="content" activeIndex="#{DatasetPage.selectedTabIndex}">
                            <p:tab id="dataFilesTab" title="Files" rendered="#{(empty DatasetPage.editMode or DatasetPage.editMode == 'FILE' or DatasetPage.editMode == 'CREATE')}" >
                                <p:message for="fileUpload" showDetail="true"/>
                                <p:fileUpload id="fileUpload" dragDropSupport="true" auto="true" multiple="true" rendered="#{DatasetPage.editMode == 'FILE' or DatasetPage.editMode == 'CREATE'}"
                                              fileUploadListener="#{DatasetPage.handleFileUpload}" update="filesTable" label="Select Files to Add" style="margin-top:.5em;"/>
                    <style type="text/css">
                        div[id$="filesTable"] .ui-datatable-tablewrapper thead {display:none;}
                    </style>
                                <p:dataTable id="filesTable" value="#{DatasetPage.dataset.files}" var="file">
                                    <p:column>
                                        <h:outputText id="fileNameOutput" value="#{file.name}" rendered="#{!(DatasetPage.editMode == 'FILE' or DatasetPage.editMode == 'CREATE')}"/>
                                        <p:inputText id="fileName" value="#{file.name}" rendered="#{DatasetPage.editMode == 'FILE' or DatasetPage.editMode == 'CREATE'}"/>
                                        <p:message for="fileName"/>
                                       <p:graphicImage value="/api/access/datafile/#{file.id}?imageThumb=true" rendered="#{!empty file.id and file.image}"/>
                                    </p:column>
                                    <p:column>
                                        <h:outputText id="fileDescNonEmpty" value="#{file.description}" rendered="#{!(DatasetPage.editMode == 'FILE' or DatasetPage.editMode == 'CREATE') and !(empty file.description)}"/>
                                        <h:outputText id="fileDescEmpty" value="NO DESCRIPTION AVAILABLE" rendered="#{!(DatasetPage.editMode == 'FILE' or DatasetPage.editMode == 'CREATE') and (empty file.description)}"/>

                                        <p:inputText id="fileDescription" value="#{file.description}" rendered="#{DatasetPage.editMode == 'FILE' or DatasetPage.editMode == 'CREATE'}"/>
                                        <p:message for="fileDescription"/>
                                    </p:column>
                                    <p:column>
                                       <h:outputLink value="/api/access/datafile/#{file.id}"  rendered="#{!empty file.id}">
                           			<h:outputText value="Download"/>
                        		</h:outputLink>
                                        <h:outputText value="[UNSAVED FILE]" rendered="#{empty file.id}"/>
                                    </p:column>
                                    <p:column>
                                        <h:outputText id="fileTypeOutputTabular" value="Tabular Data " rendered="#{file.tabularData}"/>
					<h:outputLink value="/dataexplore/gui.html?dfId=#{file.id}" target="_new" rendered="#{file.tabularData}">
                            			<h:outputText value="(Explore Data)"/>
                        		</h:outputLink>

                                        <h:outputText id="fileTypeOutputRegular" value="#{file.contentType}" rendered="#{!(file.tabularData)}"/>
                                    </p:column>
                                </p:dataTable>
                            </p:tab>                                                       
                           
                            <p:tab id="metadataMapEdit" title="Metadata Map Accordion Panel" rendered="#{empty DatasetPage.editMode or DatasetPage.editMode == 'METADATA'}">
                                 <h:outputText  value="Something for the Tab..." />
                                <p:accordionPanel>
                                  <p:dataGrid columns="1" value="#{DatasetPage.metadataBlockValues}" var="metadataBlockVal">
                                  <p:column>  
                                  <p:tab title="#{metadataBlockVal.key.displayName}">                                                                                                                                                         
                                        <p:dataGrid columns="1" value="#{metadataBlockVal.value}" var="fieldValues" rendered="#{empty DatasetPage.editMode}">                                    
                                            <p:column>                                 
                                                <h:outputText  value="#{fieldValues.datasetField.title}:  " />
                                                <h:outputText  value="#{fieldValues.strValue}" />
                                            </p:column>
                                    
                                        </p:dataGrid>                                                                        
                                        <p:dataGrid columns="1" value="#{metadataBlockVal.value}" var="fieldValues" rendered="#{DatasetPage.editMode == 'METADATA'}">                                    
                                            <p:column>                                 
                                                <h:outputText  value="#{fieldValues.datasetField.title}:  " />
                                                <p:inputText id="input_Textblock" size="90"
                                                                             value="#{fieldValues.strValue}">
                                                 </p:inputText>
                                            </p:column>                                    
                                        </p:dataGrid>                               
                                      </p:tab>
                                      </p:column>
                                       </p:dataGrid> 
                                  </p:accordionPanel>
                            </p:tab>
                            
                            <p:tab id="metadataMapTab" title="Metadata Map Without Accordion" rendered="#{empty DatasetPage.editMode or DatasetPage.editMode == 'METADATA'}">
                                  <h:outputText  value="Something for the Tab..." />
                                  <p:dataGrid columns="1" value="#{DatasetPage.metadataBlockValues}" var="metadataBlockVal">
                                    <p:column>  
                                    <h:outputText value="#{metadataBlockVal.key.displayName}"/>                                                                                                                                                         
                                        <p:dataGrid columns="1" value="#{metadataBlockVal.value}" var="fieldValues" rendered="#{empty DatasetPage.editMode}">                                    
                                            <p:column>                                 
                                                <h:outputText  value="#{fieldValues.datasetField.title}:  " />
                                                <h:outputText  value="#{fieldValues.strValue}" />
                                            </p:column>                                    
                                        </p:dataGrid>                                                                        
                                        <p:dataGrid columns="1" value="#{metadataBlockVal.value}" var="fieldValues" rendered="#{DatasetPage.editMode == 'METADATA'}">                                    
                                            <p:column>                                 
                                                <h:outputText  value="#{fieldValues.datasetField.title}:  " />
                                                <p:inputText id="input_Textblock" size="90"
                                                                             value="#{fieldValues.strValue}">
                                                 </p:inputText>
                                            </p:column>                                    
                                        </p:dataGrid>                               
                                   </p:column>
                                 </p:dataGrid> 
                            </p:tab>
                            <p:tab id="versionsTab" title="Versions" rendered="#{empty DatasetPage.editMode}">
                                <p:dataTable id="versionsTable" value="#{DatasetPage.dataset.versions}" var="version">
                                    <p:column>
                                        <h:outputText id="versionTitleOutput" value="#{version.title}" />
                                    </p:column>
                                    <p:column>
                                        <h:outputText id="versionDateOutput" value="#{version.lastUpdateTime}" />
                                    </p:column>
                                    <p:column>
                                        <h:outputText id="versionStatusOutput" value="#{version.versionState}" />
                                    </p:column>
                                </p:dataTable>
                            </p:tab>
                        </p:tabView>
                    </p:panel>

                    <!-- Create/Save Dataset Button Panel -->
                    <p:panel styleClass="panelLayoutButtonBlock" rendered="#{!empty DatasetPage.editMode}">
                        <p:commandButton id="save"  value="#{DatasetPage.editMode == 'CREATE' ? 'Create Dataset' : 'Save Changes'}" action="#{DatasetPage.save()}" update="@all">                            
                        </p:commandButton>
                        <p:commandButton id="cancel" value="Cancel" action="#{DatasetPage.cancel}" process="@this" update="@all"  rendered="#{DatasetPage.editMode != 'CREATE'}">
                            <f:setPropertyActionListener target="#{DatasetPage.selectedTabIndex}" value="#{DatasetPage.editMode == 'METADATA' ? 1 : DatasetPage.selectedTabIndex}"/>
                        </p:commandButton>
                        <p:button id="cancelCreate" value="Cancel" outcome="/dataverse.xhtml?id=#{DatasetPage.ownerId}"  rendered="#{DatasetPage.editMode == 'CREATE'}" />
                    </p:panel>
                </h:form>
            </ui:define>
        </ui:composition>
    </h:body>
</html>