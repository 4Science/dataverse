<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:p="http://primefaces.org/ui">

    <h:head>
    </h:head>

    <h:body>
        <ui:composition template="/dataverse_template.xhtml">
            <ui:param name="pageTitle" value="Dataverse"/>
            <ui:param name="dataverse" value="#{DataversePage.dataverse}"/>
            <ui:param name="ownerId" value="#{DataversePage.ownerId}"/> 
            <ui:define name="body">        

                <f:metadata>
                    <f:viewParam name="id" value="#{DataversePage.dataverse.id}"/>
                    <f:viewParam name="ownerId" value="#{DataversePage.ownerId}"/>
                    <f:viewParam name="q" value="#{DataversePage.q}"/>
                    <f:viewAction action="#{DataversePage.init}"/>
                </f:metadata>

                <h:form id="dataverseForm">
                    <!-- Breadcrumbs Panel -->
                    <p:panel styleClass="panelLayoutBlock breadcrumbNavBlock" rendered="#{!DataversePage.editMode}">

                        <ui:repeat value="#{DataversePage.dataverse.owners}" var="owner">
                            <h:outputLink value="/dataverse.xhtml?id=#{owner.id}">
                                <h:outputText value="#{owner.name} Dataverse"/>
                            </h:outputLink>
                            <h:outputText value=" > "/>
                        </ui:repeat>
                        <!--<br/>-->
                        <h:outputText value="#{DataversePage.dataverse.name} Dataverse"  style="font-weight:bold;"/>
                    </p:panel>

                    <!-- Message Panel -->
                    <p:panel styleClass="panelLayoutTitleBlock" rendered="#{DataversePage.editMode}">

                        <p:messages id="messages" showDetail="true" autoUpdate="true" closable="true"/>

                <!--<h:outputText value="Edit your dataverse's information:" rendered="#{DataversePage.dataverse.id != null}"/>-->
                <!--<h:outputText value="Create a child dataverse:" rendered="#{DataversePage.dataverse.id == null and DataversePage.ownerId != null}"/>-->
                <!--<h:outputText value="Create Root Dataverse" style="font-size:1.5em;font-weight:bold;" rendered="#{DataversePage.dataverse.id == null and DataversePage.ownerId == null}"/>-->

                    </p:panel>

                    <!-- Name Panel -->
                    <p:panel styleClass="panelLayoutBlock">

                        <p:panelGrid styleClass="panelgridLayoutTable" columns="2" rendered="#{DataversePage.editMode}">
                            <p:panelGrid columns="2">
                                <ui:fragment>
                                    <p:inputText id="name" value="#{DataversePage.dataverse.name}"/>
                                    <p:outputLabel value=" Dataverse" for="name"/>
                                    <p:watermark for="name" value="Enter name..."/>
                                </ui:fragment>
                                <p:message for="name"/>
                            </p:panelGrid>
                            <p:panelGrid columns="2" rendered="#{DataversePage.ownerId != null}">
                                <h:outputText value="Host Dataverse"/>
                                <p:selectOneMenu id="hostDataverse" value="#{DataversePage.ownerId}" filter="true" filterMatchMode="startsWith" effect="none">
                                    <f:selectItems value="#{dataverseServiceBean.findAll()}" var="dv" itemLabel="#{dv.name}" itemValue="#{dv.id}"
                                                   itemDisabled="#{dv eq DataversePage.dataverse or dv.owners.contains(DataversePage.dataverse)}"/>
                                </p:selectOneMenu>
                            </p:panelGrid>
                        </p:panelGrid>

                    </p:panel>

                    <!-- Info / Buttons Panel -->
                    <p:panel styleClass="panelLayoutBlock" rendered="#{(not empty DataversePage.owner and permissionServiceBean.on(DataversePage.owner).canIssueCommand('RenameDataverseCommand')) or DataversePage.editMode}">
                        <p:panelGrid styleClass="panelgridLayoutTable" columns="2" columnClasses="leftClass,rightClass">
                            <ui:fragment>
                                <p:panelGrid columns="2" styleClass="panelgridFormTable">
                                    <p:outputLabel value="Alias" for="alias"/>
                                    <ui:fragment>
                                        <h:outputText id="aliasOutput" value="#{DataversePage.dataverse.alias}" rendered="#{!DataversePage.editMode}"/>
                                        <p:panelGrid columns="2" rendered="#{DataversePage.editMode}">
                                            <p:inputText id="alias" value="#{DataversePage.dataverse.alias}"/>
                                            <p:message for="alias"/>
                                        </p:panelGrid>
                                    </ui:fragment>

                                    <p:outputLabel value="Contact E-mail" for="contactEmail"/>
                                    <ui:fragment>
                                        <h:outputText id="contactEmailOutput" value="#{DataversePage.dataverse.contactEmail}" rendered="#{!DataversePage.editMode}"/>
                                        <p:panelGrid columns="2" rendered="#{DataversePage.editMode}">
                                            <p:inputText id="contactEmail" value="#{DataversePage.dataverse.contactEmail}"/>
                                            <p:message for="contactEmail"/>
                                        </p:panelGrid>
                                    </ui:fragment>

                                    <p:outputLabel value="Affiliation" for="affiliation"/>
                                    <ui:fragment>
                                        <h:outputText id="affiliationOutput" value="#{DataversePage.dataverse.affiliation}" rendered="#{!DataversePage.editMode}"/>
                                        <p:panelGrid columns="2" rendered="#{DataversePage.editMode}">
                                            <p:inputText id="affiliation" value="#{DataversePage.dataverse.affiliation}"/>
                                            <p:message for="affiliation"/>
                                        </p:panelGrid>
                                    </ui:fragment>
                                </p:panelGrid>
                            </ui:fragment>

                            <ui:fragment rendered="#{!empty dataverseSession.user and !DataversePage.editMode}">
                                <p:menuButton id="editDataverse" value="Edit Dataverse" iconPos="right">
                                    <p:menuitem id="editInfo" value="Edit Info" actionListener="#{DataversePage.edit}" update="@all"/>
                                    <p:menuitem id="manageRoles" value="Manage Roles" outcome="manage-roles">
                                        <f:param name="dataverseId" value="#{DataversePage.dataverse.id}" />
                                    </p:menuitem>
                                    <p:menuitem value="Edit Theme" disabled="true"/>
                                    <p:menuitem value="Edit Permissions" disabled="true"/>
                                </p:menuButton>
                            </ui:fragment>
                        </p:panelGrid>
                    </p:panel>

                    <!-- Description Panel -->
                    <p:panel styleClass="panelLayoutBlock">
                        <p:panelGrid styleClass="panelgridLayoutTable" columns="2" columnClasses="leftClass,rightClass">
                            <ui:fragment>
                                <h:outputText value="#{DataversePage.dataverse.description}" rendered="#{!DataversePage.editMode}"/>
                                <p:panelGrid columns="3" styleClass="panelgridFormTable" rendered="#{DataversePage.editMode}">
                                    <p:outputLabel value="Description" for="description"/>
                                    <ui:fragment>
                                        <p:inputTextarea id="description" value="#{DataversePage.dataverse.description}"
                                                         rows="5" cols="50" counter="counter" maxlength="1000"
                                                         counterTemplate="{0} characters remaining" autoResize="false"/>
                                        <h:outputText id="counter" style="display:block;"/>
                                    </ui:fragment>
                                    <p:message for="description"/>
                                </p:panelGrid>
                            </ui:fragment>
                            <ui:fragment rendered="#{!DataversePage.editMode}">
                                &#160;
                            </ui:fragment>
                        </p:panelGrid>
                    </p:panel>

                    <!-- Create Dataverse Button Panel -->
                    <p:panel styleClass="panelLayoutButtonBlock" rendered="#{DataversePage.editMode}">
                        <p:commandButton id="save" value="#{DataversePage.dataverse.id == null ? 'Create Dataverse' : 'Save Changes'}" actionListener="#{DataversePage.save}" update="@all"/>
                        <p:commandButton id="cancel" value="Cancel" actionListener="#{DataversePage.cancel}" process="@this" update="@all" rendered="#{DataversePage.dataverse.id != null}"/>
                        <p:button value="Cancel" outcome="/dataverse.xhtml?id=#{DataversePage.ownerId}" rendered="#{DataversePage.dataverse.id == null and DataversePage.ownerId != null}"/>
                    </p:panel>
                </h:form>

                <!-- Search / Share Panel -->
                <p:panel styleClass="panelLayoutBlock" rendered="#{!DataversePage.editMode}">
                    <p:focus/>
                    <p:panelGrid styleClass="panelgridLayoutTable" columns="2" columnClasses="leftClass,rightClass">
                        <ui:fragment>
                            <h:form id="searchForm">
                                <p:autoComplete id="autoCompleteSearch" size="40" value="#{SearchPage.query}" completeMethod="#{autoCompleteBean.complete}" style="margin-right:1em;"/>
                                <p:watermark for="autoCompleteSearch" value="*"/>
                                <!--https://blogs.oracle.com/enterprisetechtips/entry/post_redirect_get_and_jsf-->
                                <p:commandButton id="searchbutton" value="Find" action="search.xhtml?faces-redirect=true&amp;includeViewParams=true" update="@all"/>
                            </h:form>
                        </ui:fragment>

                        <ui:fragment rendered="#{permissionServiceBean.on(DataversePage.dataverse).canIssueCommand('DatasetCreate')}">
                            <h:form id="shareForm" style="margin-left:auto;">
                                <p:menuButton id="shareData" value="Add Data" iconPos="right">
                                    <p:menuitem id="createDataverse" value="Create Dataverse" url="/dataverse.xhtml?ownerId=#{DataversePage.dataverse.id}"/>
                                    <p:menuitem id="UploadDataset" value="Add Dataset" url="/dataset.xhtml?ownerId=#{DataversePage.dataverse.id}"/>
                                    <p:menuitem value="Link to Existing Dataverse" disabled="true"/>
                                    <p:menuitem value="Link to Existing Dataset" disabled="true"/>
                                    <p:menuitem value="Create Query" disabled="true"/>
                                </p:menuButton>
                            </h:form>
                        </ui:fragment>
                    </p:panelGrid>
                </p:panel>

                <!-- Content Panel -->
                <p:panel styleClass="panelLayoutBlock dataverseChildren" rendered="#{!DataversePage.editMode}">
                    <p:dataList value="#{DataversePage.contents}" var="item">
                        <ui:fragment rendered="#{item.class.simpleName eq 'Dataverse'}">
                            <h:outputLink value="/dataverse.xhtml?id=#{item.id}">
                                <h:outputText value="#{item.name}" style="padding:4px 0 4px 30px; background: url(/resources/images/icon_dataverse.png) no-repeat 4px 50% / 22px;"/>
                                <h:outputText value=" (#{item.affiliation})" rendered="#{!empty item.affiliation}"/>
                            </h:outputLink>
                        </ui:fragment>
                        <ui:fragment rendered="#{item.class.simpleName eq 'Dataset'}">
                            <h:outputLink value="/dataset.xhtml?id=#{item.id}">
                                <h:outputText value="#{item.latestVersion.metadata.title}" style="padding:4px 0 4px 30px; background: url(/resources/images/icon_dataset.png) no-repeat 6px 50% / 20px;"/>
                            </h:outputLink>

                        </ui:fragment>
                    </p:dataList>
                </p:panel>
            </ui:define>
        </ui:composition>        
    </h:body>
</html>
