<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:p="http://primefaces.org/ui">

    <h:head>
        <title>Dataverse</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <meta http-equiv="Content-Language" content="en"/>
		<h:outputStylesheet library="css" name="componentStyles.css" />
        <style type="text/css">
            .panelgridHeaderTable {width:100%;}
            .panelgridHeaderTable .ui-widget-content, .panelgridHeaderTable .ui-widget-content > td {border:0; background:none;}
            .panelgridHeaderTable .ui-widget-content > td:last-child table {margin-left:auto;}

            .panelLayoutBlock, .panelLayoutTitleBlock, .panelLayoutButtonBlock {border:0;}
            .panelLayoutBlock .ui-panelgrid.panelgridLayoutTable .ui-widget-content, .panelLayoutBlock .ui-panelgrid.panelgridLayoutTable .ui-widget-content > td {border:0;}

            .panelgridLayoutTable, .panelgridFormTable {width:100%;}
            .panelgridFormTable > tbody > tr.ui-widget-content > td:first-child {width:20%;}

            .panelLayoutButtonBlock button {margin-right:2em;}

            .panelLayoutBlock > .ui-widget-content {border-bottom:1px solid #DDDDDD;}
            .panelLayoutBlock.breadcrumbNavBlock > .ui-widget-content {border-bottom:0;}
            .panelLayoutTitleBlock > .ui-widget-content {border:0;}

            .panelLayoutBlock .ui-panelgrid.panelgridLayoutTable .ui-widget-content .ui-panelgrid {margin-bottom: 1em;}
            .panelLayoutBlock .ui-panelgrid.panelgridLayoutTable .ui-widget-content .ui-panelgrid .ui-widget-content .ui-panelgrid {margin-bottom: 0}
            .panelLayoutBlock .ui-panelgrid.panelgridLayoutTable .ui-widget-content .ui-panelgrid .ui-widget-content .ui-panelgrid td:first-child {padding-left:0;}

            .rightClass {text-align: right;}
            
            .dataverseChildren .ui-datalist-data {padding-left:1em;}
            .dataverseChildren .ui-datalist-data li.ui-datalist-item {list-style-type:none; margin-left:0; margin-bottom:6px;}
        </style>
    </h:head>

    <h:body>
        <f:metadata>
            <f:viewParam name="dataverseId" value="#{DataversePage.dataverse.id}"/>
            <f:viewParam name="id" value="#{manageRolesPage.viewRoleId}"/>
            <f:viewParam name="intent" value="#{manageRolesPage.intentParam}"/>
			<f:viewParam name="objectType" value="#{manageRolesPage.objectTypeParam}"/>
            <f:viewAction action="#{manageRolesPage.init}"/>
        </f:metadata>
		<ui:composition template="/dataverse_template.xhtml">
            <ui:param name="pageTitle" value="Manage Roles and Permissions"/>
            <ui:param name="dataverse" value="#{DataversePage.dataverse}"/> 
            <ui:define name="body">
				
				<!-- Tabs -->
				<p:tabView dynamic="true" cache="false" activeIndex="#{manageRolesPage.activeTabIndex}">
					<p:tab id="dataverseTab" title="Dataverse">
						<h:form id="dvForm">
							<p:panelGrid styleClass="panelgridLayoutTable" columns="1" columnClasses="leftClass,rightClass">
								<p:panelGrid styleClass="panelgridLayoutTable" columns="3" columnClasses="leftClass, leftClass, leftClass">
									<h:outputText value="Permission Inheritance" />
									<h:panelGroup>
										<h:selectBooleanCheckbox id="permissionRootCb" value="#{manageRolesPage.permissionRoot}" />
										<h:outputLabel for="permissionRootCb" value="Permission Root" />
									</h:panelGroup>
									<h:panelGroup>
										When a dataverse is defined as a permission root,
										it does not honor roles granted to users on its parents dataverses.
										Unless this dataverse holds data which is significantly more restricted
										than the data in the parent dataverse, you probably want to keep this
										box unchecked.
									</h:panelGroup>
									<h:outputText value="Guest User" />
									<div class="placeholder">We'll have a list of applicable roles here.</div>
									<h:panelGroup>
										Define what guest users can and cannot do on this dataverse.
									</h:panelGroup>
								</p:panelGrid>
							</p:panelGrid>
							<p:commandButton value="Save" actionListener="#{manageRolesPage.saveDataverse()}" />
						</h:form>
					</p:tab>

					<p:tab id="roleTab" title="Roles">
						<!-- LIST -->
						<ui:fragment rendered="#{manageRolesPage.intent eq 'LIST'}">
							<p:panel>
								<h:form>
									<p:commandButton id="newRole" value="Create New Role" 
													 actionListener="#{manageRolesPage.createNewRole}" 
													 update="@all"/>
								</h:form>
							</p:panel>
							<p:panel>
								<p:dataList value="#{manageRolesPage.getRoles()}" var="role" rendered="#{manageRolesPage.hasRoles}">
									<h:link outcome="manage-roles" value="edit" styleClass="pull-right">
										<f:param name="dataverseId" value="#{DataversePage.dataverse.id}"/>
										<f:param name="id" value="#{role.id}"/>
										<f:param name="objectType" value="ROLES" />
										<f:param name="intent" value="EDIT"/>
									</h:link>
									<h:link outcome="manage-roles" value="#{role.name}">
										<f:param name="dataverseId" value="#{DataversePage.dataverse.id}"/>
										<f:param name="id" value="#{role.id}"/>
										<f:param name="objectType" value="ROLES" />
										<f:param name="intent" value="VIEW"/>
									</h:link>
								</p:dataList>
								<p:panel rendered="#{! manageRolesPage.hasRoles}">
									No roles are defined for Dataverse '#{DataversePage.dataverse.name}'.
									<h:outputText rendered="#{! DataversePage.dataverse.effectivlyPermissionRoot}">
										Any roles applied to users at parent dataverses, are valid in this
										dataverse as well.
									</h:outputText>
									<h:form>
										<p:commandLink value="Create a new role"  actionListener="#{manageRolesPage.createNewRole()}" update="@all"/>
									</h:form>
								</p:panel>
							</p:panel>
						</ui:fragment>

						<!-- EDIT -->
						<ui:fragment rendered="#{manageRolesPage.intent eq 'EDIT'}">
							<h:form id="roleForm">
								<p:panel styleClass="panelLayoutBlock" header="Role Properties">
									<p:panelGrid styleClass="panelgridLayoutTable" columns="2" columnClasses="leftClass,leftClass">
										<p:outputLabel value="Name" for="roleName"/>
										<p:inputText id="roleName" value="#{manageRolesPage.role.name}"/>
										<p:watermark for="roleName" value="Enter a name for the role..."/>
										<p:message for="roleName"/>

										<p:outputLabel value="Alias" for="roleAlias"/>
										<p:inputText id="roleAlias" value="#{manageRolesPage.role.alias}"/>
										<p:watermark for="roleAlias" value="Enter alias for the role..."/>
										<p:message for="roleAlias"/>

										<p:outputLabel value="Description" for="description"/>
										<h:panelGroup>
											<p:inputTextarea id="description" value="#{manageRolesPage.role.description}"
															 rows="5" cols="50" counter="counter" maxlength="1000"
															 counterTemplate="{0} characters remaining" autoResize="false"/>
											<h:outputText id="counter" style="display:block;"/>
										</h:panelGroup>
										<p:watermark for="description" value="Describe the role (1000 characters max)"/>
										<p:message for="description"/>
									</p:panelGrid>
								</p:panel>
								<p:panel styleClass="panelLayoutBlock" header="Role Permissions">
									<h:selectManyCheckbox id="pageDirection" value="#{manageRolesPage.selectedPermissions}"  
										layout="pageDirection"> 
										<f:selectItems value="#{manageRolesPage.permissions}" var="pmsn" 
													   itemLabel="#{pmsn.humanName} (#{pmsn.name()})"
													   itemValue="#{pmsn}"
													   />
									</h:selectManyCheckbox>  
								</p:panel>
								<p:panel styleClass="panelLayoutButtonBlock">
									<ul class="navigationLinks">
										<li>
											<p:commandButton id="save" value="#{manageRolesPage.role.id == null ? 'Create Role' : 'Save Changes'}" 
															 actionListener="#{manageRolesPage.saveRole}" update="@all"/>
										</li>
										<li>
											<h:link outcome="manage-roles" value="Back to roles list">
												<f:param name="intent" value="LIST" />
												<f:param name="objectType" value="ROLES" />
												<f:param name="dataverseId" value="#{DataversePage.dataverse.id}"/>
											</h:link>
										</li>
									</ul>
								</p:panel>
							</h:form>
						</ui:fragment>

						<!-- VIEW -->
						<ui:fragment rendered="#{manageRolesPage.intent eq 'VIEW'}">
							<p:panel styleClass="panelLayoutBlock" header="Role Properties">
								<p:panelGrid styleClass="panelgridLayoutTable" columns="2" columnClasses="leftClass,rightClass">
									<p:panelGrid columns="2" styleClass="panelgridFormTable">
										<h:outputText value="Name"/>
										<h:outputText id="name" value="#{manageRolesPage.role.name}"/>

										<h:outputText value="Alias"/>
										<h:outputText id="alias" value="#{manageRolesPage.role.alias}"/>

										<h:outputText value="Description"/>
										<h:outputText id="description" value="#{manageRolesPage.role.description}"/>

									</p:panelGrid>
								</p:panelGrid>
							</p:panel>
							<p:panel styleClass="panelLayoutBlock" header="Role Permissions">
								<p:dataList id="dvList" value="#{manageRolesPage.rolePermissions}" var="pmsn" emptyMessage="This role has no permissions.">
									#{pmsn.humanName}
								</p:dataList>
							</p:panel>
							<p:panel styleClass="panelLayoutButtonBlock">
								<ul class="navigationLinks">
									<li>
										<h:link outcome="manage-roles" value="Back to roles list">
											<f:param name="intent" value="LIST" />
											<f:param name="objectType" value="ROLES" />
											<f:param name="dataverseId" value="#{DataversePage.dataverse.id}"/>
										</h:link>
									</li>
									<li>
										<h:link outcome="manage-roles" value="Edit this role">
											<f:param name="id" value="#{manageRolesPage.role.id}" />
											<f:param name="intent" value="EDIT" />
											<f:param name="objectType" value="ROLES" />
											<f:param name="dataverseId" value="#{DataversePage.dataverse.id}"/>
										</h:link>
									</li>
								</ul>
							</p:panel>
						</ui:fragment>
					</p:tab>

					<p:tab id="userTab" title="Users">
						Assign roles to users here!
					</p:tab>

				</p:tabView>
			</ui:define>
		</ui:composition>
    </h:body>
</html>
