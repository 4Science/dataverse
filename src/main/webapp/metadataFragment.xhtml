<div xmlns="http://www.w3.org/1999/xhtml"
     xmlns:h="http://java.sun.com/jsf/html"
     xmlns:f="http://java.sun.com/jsf/core"
     xmlns:ui="http://java.sun.com/jsf/facelets"
     xmlns:c="http://java.sun.com/jsp/jstl/core"
     xmlns:p="http://primefaces.org/ui">


    <div class="panel-group">
        <ui:repeat value="#{DatasetPage.datasetVersionUI.metadataBlockValues}" var="metadataBlockVal" varStatus="block">
            <div class="panel panel-default">
                <div data-toggle="collapse" data-target="#collapse#{block.index}" class="panel-heading">
                    #{metadataBlockVal.key.displayName}
                </div>

                <div id="collapse#{block.index}" class="collapse #{block.first?'in':''}">
                    <div class="panel-body">
                        <ui:repeat value="#{metadataBlockVal.value}" var="fieldValues">
                            <ui:fragment rendered="#{((DatasetPage.editMode == 'METADATA' or (DatasetPage.editMode == 'CREATE' and fieldValues.datasetField.displayOnCreate)) and !fieldValues.datasetField.hasParent) 
                                                     or (empty DatasetPage.editMode and (!empty fieldValues.strValue or (fieldValues.datasetField.hasChildren and !fieldValues.childEmpty)))}">
                                <div class="form-group">
                                    <ui:fragment rendered="#{!fieldValues.datasetField.hasParent}">
                                        <label for="metadata_#{fieldValues.datasetField.name}" class="col-sm-4 control-label">
                                            <a href="#" data-toggle="tooltip" data-placement="auto right" class="tooltiplabel right" data-original-title="Default tooltip placeholder text." title="">
                                                #{fieldValues.datasetField.title}
                                            </a>
                                        </label>
                                    </ui:fragment>

                                    <ui:fragment rendered="#{!fieldValues.datasetField.hasChildren and !fieldValues.datasetField.hasParent}">
                                        <div class="col-sm-6">
                                            <h:outputText value="#{fieldValues.strValue}" rendered="#{empty DatasetPage.editMode  and !empty fieldValues.strValue}" />                                                                   
                                            <p:inputText styleClass="form-control" id="metadata_#{fieldValues.datasetField.name}" value="#{fieldValues.strValue}" 
                                                         rendered="#{!empty DatasetPage.editMode
                                                                     and empty fieldValues.datasetField.controlledVocabularySelectItems
                                                                     and (fieldValues.datasetField.fieldType == 'text'
                                                                     or fieldValues.datasetField.fieldType == 'url'
                                                                     or fieldValues.datasetField.fieldType == 'date'
                                                                     or fieldValues.datasetField.fieldType == '')}" />
                                            <p:inputTextarea rows="5" cols="80" id="description" value="#{fieldValues.strValue}" 
                                                             rendered="#{!empty DatasetPage.editMode
                                                                         and empty fieldValues.datasetField.controlledVocabularySelectItems
                                                                         and fieldValues.datasetField.fieldType == 'textbox'}" />
                                            <!--<h:selectManyListbox value="#{fieldValues.strValue}" 
                                                                 rendered="#{!empty DatasetPage.editMode
                                                                             and !empty fieldValues.datasetField.controlledVocabularySelectItems
                                                                             and fieldValues.datasetField.allowMultiples }">
                                                <f:selectItems value="#{fieldValues.datasetField.controlledVocabularySelectItems}" />
                                            </h:selectManyListbox>     -->   
                                            <p:selectOneMenu  value="#{fieldValues.strValue}" 
                                                              filterMatchMode="startsWith"
                                                              rendered="#{!empty DatasetPage.editMode
                                                                          and !empty fieldValues.datasetField.controlledVocabularySelectItems
                                                                          and !fieldValues.datasetField.allowMultiples }">
                                                <f:selectItems value="#{fieldValues.datasetField.controlledVocabularySelectItems}" />
                                            </p:selectOneMenu>                                            
                                        </div>
                                    </ui:fragment>

                                    <ui:fragment rendered="#{!empty DatasetPage.editMode and fieldValues.datasetField.hasChildren}">
                                        <div class="col-sm-6">
                                            <!-- CHILDS -->
                                            <ui:repeat value="#{fieldValues.childDatasetFieldValues}" var="childVal" rendered="#{!fieldValues.datasetField.hasChildren}">                                                              
                                                <div class="form-group col-sm-6">
                                                    <label class="control-label" for="metadata_BLANK">
                                                        <a class="tooltiplabel right" data-original-title="Default tooltip placeholder text." data-placement="auto right" data-toggle="tooltip" href="#">#{childVal.datasetField.title}</a>
                                                    </label>
                                                    <div><h:outputText value="#{childVal.strValue}" rendered="#{childVal.parentDatasetFieldValue == fieldValues}"/> </div>
                                                </div>
                                            </ui:repeat>                                                                

                                            <ui:repeat value="#{fieldValues.childDatasetFieldValues}" var="childVal" rendered="#{fieldValues.datasetField.hasChildren}">
                                                <div class="form-group col-sm-6">
                                                    <label class="control-label" for="metadata_BLANK">
                                                        <a class="tooltiplabel right" data-original-title="Default tooltip placeholder text." data-placement="auto right" data-toggle="tooltip" href="#">#{childVal.datasetField.title}</a>
                                                    </label>                                                                       
                                                    <p:inputText value="#{childVal.strValue}" 
                                                                 rendered="#{childVal.parentDatasetFieldValue == fieldValues
                                                                             and empty childVal.datasetField.controlledVocabularySelectItems        
                                                                             and (childVal.datasetField.fieldType == 'text'
                                                                             or childVal.datasetField.fieldType == ''
                                                                             or childVal.datasetField.fieldType == 'url'
                                                                             or childVal.datasetField.fieldType == 'date')}"/>
                                                    <p:inputTextarea rows="5" cols="80" id="description" value="#{childVal.strValue}" 
                                                                     rendered="#{childVal.parentDatasetFieldValue == fieldValues
                                                                                 and childVal.datasetField.fieldType == 'textbox'}" />

                                                    <h:selectManyListbox value="#{childVal.strValue}" 
                                                                         rendered="#{!empty childVal.datasetField.controlledVocabularySelectItems
                                                                                     and childVal.datasetField.allowMultiples }">
                                                        <f:selectItems value="#{childVal.datasetField.controlledVocabularySelectItems}" />
                                                    </h:selectManyListbox>        
                                                    <p:selectOneMenu  value="#{childVal.strValue}" 
                                                                      filterMatchMode="startsWith"
                                                                      rendered="#{!empty childVal.datasetField.controlledVocabularySelectItems
                                                                                  and !childVal.datasetField.allowMultiples }">
                                                        <f:selectItems value="#{childVal.datasetField.controlledVocabularySelectItems}" />
                                                    </p:selectOneMenu>

                                                </div>
                                            </ui:repeat>
                                        </div>
                                    </ui:fragment>

                                    <ui:fragment rendered="#{empty DatasetPage.editMode  and fieldValues.datasetField.hasChildren and !fieldValues.childEmpty}">
                                        <div class="col-sm-6" >
                                            <!-- CHILDS -->
                                            <ui:repeat value="#{fieldValues.childDatasetFieldValues}" var="childVal" rendered="#{empty DatasetPage.editMode and fieldValues.datasetField.hasChildren}">                                                              
                                                <ui:fragment rendered="#{!empty childVal.strValue and childVal.parentDatasetFieldValue == fieldValues}">
                                                    <div class="form-group col-sm-6" >
                                                        <label class="control-label" for="metadata_BLANK">
                                                            <a class="tooltiplabel right" data-original-title="Default tooltip placeholder text." data-placement="auto right" data-toggle="tooltip" href="#">#{childVal.datasetField.title}</a>
                                                        </label>
                                                        <div><h:outputText value="#{childVal.strValue}" rendered="#{childVal.parentDatasetFieldValue == fieldValues}"/> </div>
                                                    </div>
                                                </ui:fragment>
                                            </ui:repeat>                                                                                                                                  
                                        </div>
                                    </ui:fragment>

                                    <ui:fragment rendered="#{!empty DatasetPage.editMode and fieldValues.datasetField.allowMultiples and empty fieldValues.datasetField.controlledVocabularySelectItems}">
                                        <div class="col-xs-2">
                                            <p:commandButton styleClass="btn btn-default btn-sm" style="margin:2em 1em 0 0;"  
                                                             title="Add Record" value="&lt;span class='glyphicon glyphicon-plus'&gt;&lt;/span&gt;" escape="false" 
                                                             actionListener="#{DatasetPage.addGeneralRecord(fieldValues)}" update="@all">
                                            </p:commandButton>
                                            <p:commandButton styleClass="btn btn-default btn-sm" style="margin-top:2em;"  
                                                             title="Delete Record" value="&lt;span class='glyphicon glyphicon-minus'&gt;&lt;/span&gt;" 
                                                             escape="false" actionListener="#{DatasetPage.deleteGeneralRecord(fieldValues)}" update="@all">
                                                <f:setPropertyActionListener target="#{DatasetPage.selectedTabIndex}" value="0" />
                                            </p:commandButton>
                                        </div>
                                    </ui:fragment>
                                </div>
                            </ui:fragment>
                        </ui:repeat>
                    </div>
                </div>
            </div>
        </ui:repeat>
    </div>    





</div>