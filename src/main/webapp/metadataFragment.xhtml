<div xmlns="http://www.w3.org/1999/xhtml"
     xmlns:h="http://java.sun.com/jsf/html"
     xmlns:f="http://java.sun.com/jsf/core"
     xmlns:ui="http://java.sun.com/jsf/facelets"
     xmlns:c="http://java.sun.com/jsp/jstl/core"
     xmlns:p="http://primefaces.org/ui">

    <!-- View Mode -->
    <ui:fragment rendered="${empty DatasetPage.editMode}">
        <div class="panel-group">
            <ui:repeat value="#{DatasetPage.datasetVersionUI.metadataBlocksForView.entrySet().toArray()}" var="metadataBlockVal" varStatus="block">
                <div class="panel panel-default">
                    <div data-toggle="collapse" data-target="#collapse#{block.index}" class="panel-heading">
                        #{metadataBlockVal.key.displayName}
                    </div>
                    <div id="collapse#{block.index}" class="collapse #{block.first?'in':''}">
                        <div class="panel-body">
                            <ui:repeat value="#{metadataBlockVal.value}" var="dsf">
                                <!-- Primitive datasetFields -->
                                <ui:fragment rendered="#{!dsf.datasetField.hasChildren}">
                                    <div class="form-group">
                                        <label for="metadata_#{dsf.datasetField.name}" class="col-sm-3 control-label">
                                            <a href="#" data-toggle="tooltip" data-placement="auto right" class="tooltiplabel right" data-original-title="#{dsf.datasetField.description}" title="">
                                                #{dsf.datasetField.title}
                                            </a>
                                        </label>                  
                                        <div class="col-sm-9">
                                            <h:outputText value="#{dsf.value}" rendered="#{!dsf.datasetField.allowMultiples}"/>
                                            <ui:repeat value="#{dsf.values}" var="value" varStatus="loop" rendered="#{dsf.datasetField.allowMultiples}">
                                                <h:outputText value="#{loop.first?'':'; '}#{value}"/>
                                            </ui:repeat>                                                 
                                        </div>                                        
                                    </div>
                                </ui:fragment>  
                                <!-- Compound datasetFields -->
                                <ui:fragment rendered="#{dsf.datasetField.hasChildren}">
                                    <ui:repeat value="#{dsf.datasetFieldCompoundValues}" var="compoundValues">
                                        <div class="form-group">
                                            <label for="metadata_#{dsf.datasetField.name}" class="col-sm-3 control-label">
                                                <a href="#" data-toggle="tooltip" data-placement="auto right" class="tooltiplabel right" data-original-title="#{dsf.datasetField.description}" title="">
                                                    #{dsf.datasetField.title}
                                                </a>
                                            </label>                  
                                            <div class="col-sm-9">
                                                <!-- Sub fields -->
                                                <ui:repeat value="#{compoundValues.childDatasetFields}" var="subdsf">                                                              
                                                    <div class="col-sm-6">
                                                        <label class="control-label" for="metadata_BLANK">
                                                            <a class="tooltiplabel right" data-original-title="#{subdsf.datasetField.description}" data-placement="auto right" data-toggle="tooltip" href="#">#{subdsf.datasetField.title}</a>                                                        
                                                        </label>
                                                        <div>
                                                            <h:outputText value="#{subdsf.value}" rendered="#{!subdsf.datasetField.allowMultiples}"/>
                                                            <ui:repeat value="#{subdsf.values}" var="value" varStatus="loop" rendered="#{subdsf.datasetField.allowMultiples}">
                                                                <h:outputText value="#{loop.first?'':'; '}#{value}"/>
                                                            </ui:repeat>
                                                        </div>
                                                    </div>
                                                </ui:repeat>
                                            </div>
                                        </div>
                                    </ui:repeat> 
                                </ui:fragment>                               
                            </ui:repeat>
                        </div>
                    </div>
                </div>
            </ui:repeat>
        </div>
    </ui:fragment>


    <!-- Edit Mode -->
    <ui:fragment rendered="${!empty DatasetPage.editMode}">
        <div class="panel-group">
            <ui:repeat value="#{DatasetPage.datasetVersionUI.metadataBlocksForEdit.entrySet().toArray()}" var="metadataBlockVal" varStatus="block">
                <ui:fragment rendered="#{(DatasetPage.editMode == 'METADATA' or metadataBlockVal.key.displayOnCreate)}">
                    <div class="panel panel-default">
                        <div data-toggle="collapse" data-target="#collapse#{block.index}" class="panel-heading">
                            #{metadataBlockVal.key.displayName}
                        </div>
                        <div id="collapse#{block.index}" class="collapse #{block.first || DatasetPage.editMode == 'CREATE'?'in':''}">
                            <div class="panel-body">
                                <ui:repeat value="#{metadataBlockVal.value}" var="dsf">
                                    <ui:fragment rendered="#{(DatasetPage.editMode == 'METADATA' or dsf.datasetFieldType.displayOnCreate)}">
                                        <!-- Primitive, Single value field -->    
                                        <ui:fragment rendered="#{!dsf.datasetFieldType.hasChildren and !dsf.datasetFieldType.allowMultiples}">
                                            <div class="form-group">
                                                <label for="metadata_#{dsf.datasetFieldType.name}" class="col-sm-3 control-label">
                                                    <a href="#" data-toggle="tooltip" data-placement="auto right" class="tooltiplabel right" data-original-title="#{dsf.datasetFieldType.description}">
                                                        #{dsf.datasetFieldType.title}
                                                    </a>
                                                    <h:outputText styleClass="glyphicon glyphicon-asterisk text-danger" value="" rendered="#{dsf.datasetFieldType.required}" /> 
                                                </label>                  
                                                <ui:include src="datasetFieldForEditFragment.xhtml">
                                                    <ui:param name="fieldValues" value="#{dsf.singleValue}"/>
                                                </ui:include> 
                                            </div>
                                        </ui:fragment>
                                        <!-- Primitive, Multiple value field -->    
                                        <ui:fragment rendered="#{!dsf.datasetFieldType.hasChildren and dsf.datasetFieldType.allowMultiples}">
                                            <ui:repeat value="#{dsf.datasetFieldValues}" var="dsfv" varStatus="valCount" >    
                                                <div class="form-group">
                                                    <label for="metadata_#{dsf.datasetFieldType.name}" class="col-sm-3 control-label">
                                                        <a href="#" data-toggle="tooltip" data-placement="auto right" class="tooltiplabel right" data-original-title="#{dsf.datasetFieldType.description}">
                                                            #{dsf.datasetFieldType.title}
                                                        </a>
                                                        <h:outputText styleClass="glyphicon glyphicon-asterisk text-danger" value="" rendered="#{dsf.datasetFieldType.required}" /> 
                                                    </label>                  
                                                    <ui:include src="datasetFieldForEditFragment.xhtml">
                                                        <ui:param name="fieldValues" value="#{dsfv}"/>
                                                    </ui:include>
                                                </div> 
                                            </ui:repeat>    
                                        </ui:fragment>

                                        <!-- Compound fields -->
                                        <ui:fragment rendered="#{dsf.datasetFieldType.hasChildren}">
                                            <ui:repeat value="#{dsf.datasetFieldCompoundValues}" var="compoundValue" varStatus="valCount">
                                                <div class="form-group">
                                                    <label for="metadata_#{dsf.datasetFieldType.name}" class="col-sm-3 control-label">
                                                        <a href="#" data-toggle="tooltip" data-placement="auto right" class="tooltiplabel right" data-original-title="#{dsf.datasetFieldType.description}">
                                                            #{dsf.datasetFieldType.title}
                                                        </a>
                                                        <h:outputText styleClass="glyphicon glyphicon-asterisk text-danger" value="" rendered="#{dsf.datasetFieldType.required}" /> 
                                                    </label>                  

                                                    <div class="form-group col-sm-7">
                                                        <!-- Sub Fields -->
                                                        <ui:repeat value="#{compoundValue.childDatasetFields}" var="subdsf">                                                              
                                                            <div class="col-sm-6">

                                                                <ui:include src="datasetFieldForEditFragment.xhtml">
                                                                    <ui:param name="fieldValues" value="#{subdsf.singleValue}"/>
                                                                    <ui:param name="includeTitle" value="true"/>
                                                                </ui:include>
                                                            </div>
                                                        </ui:repeat>
                                                    </div>
                                                </div>
                                            </ui:repeat>
                                        </ui:fragment>                                        
                                    </ui:fragment>
                                </ui:repeat>
                            </div>
                        </div>
                    </div>
                </ui:fragment>
            </ui:repeat>
        </div>    
    </ui:fragment>




</div>