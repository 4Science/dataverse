<div xmlns="http://www.w3.org/1999/xhtml"
     xmlns:h="http://java.sun.com/jsf/html"
     xmlns:f="http://java.sun.com/jsf/core"
     xmlns:ui="http://java.sun.com/jsf/facelets"
     xmlns:c="http://java.sun.com/jsp/jstl/core"
     xmlns:p="http://primefaces.org/ui">

    <!-- View Mode -->
    <ui:fragment rendered="${empty DatasetPage.editMode}">
        <div class="panel-group">
            <ui:repeat value="#{DatasetPage.datasetVersionUI.metadataBlocksForView.entrySet().toArray()}" var="metadataBlockVal" varStatus="block">
                <div class="panel panel-default">
                    <div data-toggle="collapse" data-target="#collapse#{block.index}" class="panel-heading text-info">
                        #{metadataBlockVal.key.displayName} <span class="glyphicon #{block.first?'glyphicon-chevron-up':'glyphicon-chevron-down'}" style="margin-left:.3em;top:3px;"/>
                    </div>
                    <div id="collapse#{block.index}" class="collapse #{block.first?'in':''}">
                        <div class="panel-body">
                            <ui:repeat value="#{metadataBlockVal.value}" var="dsf">
                                <!-- Primitive datasetFields -->
                                <ui:fragment rendered="#{dsf.datasetFieldType.primitive}">
                                    <div class="form-group">
                                        <label for="metadata_#{dsf.datasetFieldType.name}" class="col-sm-3 control-label">
                                            <a href="#" data-toggle="tooltip" data-placement="auto right" class="tooltiplabel right" data-original-title="#{dsf.datasetFieldType.description}" title="">
                                                #{dsf.datasetFieldType.title}
                                            </a>
                                        </label>                  
                                        <div class="col-sm-9">
                                            <h:outputText value="#{dsf.value}" rendered="#{!dsf.datasetFieldType.allowMultiples}"/>
                                            <ui:repeat value="#{dsf.values}" var="value" varStatus="loop" rendered="#{dsf.datasetFieldType.allowMultiples}">
                                                <h:outputText value="#{loop.first?'':'; '}#{value}"/>
                                            </ui:repeat>                                                 
                                        </div>                                        
                                    </div>
                                </ui:fragment>  
                                <!-- Compound datasetFields -->
                                <ui:fragment rendered="#{dsf.datasetFieldType.compound}">
                                    <ui:repeat value="#{dsf.datasetFieldCompoundValues}" var="compoundValues">
                                        <div class="form-group">
                                            <label for="metadata_#{dsf.datasetFieldType.name}" class="col-sm-3 control-label">
                                                <a href="#" data-toggle="tooltip" data-placement="auto right" class="tooltiplabel right" data-original-title="#{dsf.datasetFieldType.description}" title="">
                                                    #{dsf.datasetFieldType.title}
                                                </a>
                                            </label>                  
                                            <div class="col-sm-9">
                                                <!-- Sub fields -->
                                                <ui:repeat value="#{compoundValues.childDatasetFields}" var="subdsf">                                                              
                                                    <div class="col-sm-6">
                                                        <label class="control-label" for="metadata_BLANK">
                                                            <a class="tooltiplabel right" data-original-title="#{subdsf.datasetFieldType.description}" data-placement="auto right" data-toggle="tooltip" href="#">#{subdsf.datasetFieldType.title}</a>                                                        
                                                        </label>
                                                        <div>
                                                            <h:outputText value="#{subdsf.value}" rendered="#{!subdsf.datasetFieldType.allowMultiples}"/>
                                                            <ui:repeat value="#{subdsf.values}" var="value" varStatus="loop" rendered="#{subdsf.datasetFieldType.allowMultiples}">
                                                                <h:outputText value="#{loop.first?'':'; '}#{value}"/>
                                                            </ui:repeat>
                                                        </div>
                                                    </div>
                                                </ui:repeat>
                                            </div>
                                        </div>
                                    </ui:repeat> 
                                </ui:fragment>                               
                            </ui:repeat>
                        </div>
                    </div>
                </div>
            </ui:repeat>
        </div>
    </ui:fragment>


    <!-- Edit Mode -->
    <ui:fragment rendered="${!empty DatasetPage.editMode}">
        <div class="panel-group">
            <ui:repeat value="#{DatasetPage.datasetVersionUI.metadataBlocksForEdit.entrySet().toArray()}" var="metadataBlockVal" varStatus="block">
                <ui:fragment rendered="#{(DatasetPage.editMode == 'METADATA' or metadataBlockVal.key.displayOnCreate)}">
                    <div class="panel panel-default">
                        <div data-toggle="collapse" data-target="#collapse#{block.index}" class="panel-heading text-info">
                            #{metadataBlockVal.key.displayName} <span class="glyphicon #{block.first?'glyphicon-chevron-up':'glyphicon-chevron-down'}" style="margin-left:.3em;top:3px;"/>
                        </div>
                        <div id="collapse#{block.index}" class="collapse #{block.first || DatasetPage.editMode == 'CREATE'?'in':''}">
                            <div class="panel-body">
                                <ui:repeat value="#{metadataBlockVal.value}" var="dsf">
                                    <ui:fragment rendered="#{(DatasetPage.editMode == 'METADATA' or dsf.datasetFieldType.displayOnCreate)}">
                                        
                                        <!-- Primitive fields -->    
                                        <ui:fragment rendered="#{dsf.datasetFieldType.primitive}">
                                            <ui:repeat value="#{dsf.datasetFieldValues}" var="dsfv" varStatus="valCount" >    
                                                <div class="form-group">
                                                    <label for="metadata_#{dsf.datasetFieldType.name}" class="col-sm-3 control-label">
                                                        <a href="#" data-toggle="tooltip" data-placement="auto right" class="tooltiplabel right" data-original-title="#{dsf.datasetFieldType.description}">
                                                            #{dsf.datasetFieldType.title}
                                                        </a>
                                                        <h:outputText styleClass="glyphicon glyphicon-asterisk text-danger" value="" rendered="#{dsf.datasetFieldType.required}" /> 
                                                    </label>                  
                                                    <ui:include src="datasetFieldForEditFragment.xhtml">
                                                        <ui:param name="fieldValues" value="#{dsfv}"/>
                                                    </ui:include>
                                                    <!-- Add / Remove buttons -->
                                                    <ui:fragment rendered="#{dsf.datasetFieldType.allowMultiples and !dsf.datasetFieldType.controlledVocabulary}">
                                                        <div class="col-xs-2">
                                                            <p:commandButton styleClass="btn btn-default btn-sm" style="#{dsf.datasetFieldType.compound ? 'margin:1.8em 1em 0 0;' : 'margin:0 1em 0 0;'}"  
                                                                             title="Add Record" value="&lt;span class='glyphicon glyphicon-plus'&gt;&lt;/span&gt;" escape="false" 
                                                                             actionListener="#{dsf.addDatasetFieldValue(valCount.index + 1)}" update="@all">
                                                            </p:commandButton>
                                                            <p:commandButton styleClass="btn btn-default btn-sm" style="#{dsf.datasetFieldType.compound ? 'margin-top:1.8em;' : ''}"  
                                                                             title="Delete Record" value="&lt;span class='glyphicon glyphicon-minus'&gt;&lt;/span&gt;" escape="false" 
                                                                             rendered="#{dsf.datasetFieldValues.size() > 1}"
                                                                             actionListener="#{dsf.removeDatasetFieldValue(valCount.index)}" update="@all">
                                                            </p:commandButton>
                                                        </div>
                                                    </ui:fragment>
                                                </div>
                                            </ui:repeat>    
                                        </ui:fragment>

                                        <!-- Compound fields -->
                                        <ui:fragment rendered="#{dsf.datasetFieldType.compound}">
                                            <ui:repeat value="#{dsf.datasetFieldCompoundValues}" var="compoundValue" varStatus="valCount">
                                                <div class="form-group">
                                                    <label for="metadata_#{dsf.datasetFieldType.name}" class="col-sm-3 control-label">
                                                        <a href="#" data-toggle="tooltip" data-placement="auto right" class="tooltiplabel right" data-original-title="#{dsf.datasetFieldType.description}">
                                                            #{dsf.datasetFieldType.title}
                                                        </a>
                                                        <h:outputText styleClass="glyphicon glyphicon-asterisk text-danger" value="" rendered="#{dsf.datasetFieldType.required}" /> 
                                                    </label>                  

                                                    <div class="form-group col-sm-7">
                                                        <!-- Sub Fields -->
                                                        <ui:repeat value="#{compoundValue.childDatasetFields}" var="subdsf">                                                              
                                                            <div class="col-sm-6">

                                                                <ui:include src="datasetFieldForEditFragment.xhtml">
                                                                    <ui:param name="fieldValues" value="#{subdsf.singleValue}"/>
                                                                    <ui:param name="includeTitle" value="true"/>
                                                                </ui:include>
                                                            </div>
                                                        </ui:repeat>
                                                    </div>
                                                    <ui:fragment rendered="#{dsf.datasetFieldType.allowMultiples and !dsf.datasetFieldType.controlledVocabulary}">
                                                        <div class="col-xs-2">
                                                            <p:commandButton styleClass="btn btn-default btn-sm" style="#{dsf.datasetFieldType.compound ? 'margin:1.8em 1em 0 0;' : 'margin:0 1em 0 0;'}"  
                                                                             title="Add Record" value="&lt;span class='glyphicon glyphicon-plus'&gt;&lt;/span&gt;" escape="false" 
                                                                             actionListener="#{dsf.addDatasetFieldCompoundValue(valCount.index + 1)}" update="@all">
                                                            </p:commandButton>
                                                            <p:commandButton styleClass="btn btn-default btn-sm" style="#{dsf.datasetFieldType.compound ? 'margin-top:1.8em;' : ''}"  
                                                                             title="Delete Record" value="&lt;span class='glyphicon glyphicon-minus'&gt;&lt;/span&gt;" escape="false" 
                                                                             rendered="#{dsf.datasetFieldCompoundValues.size() > 1}"
                                                                             actionListener="#{dsf.removeDatasetFieldCompoundValue(valCount.index)}" update="@all">
                                                            </p:commandButton>
                                                        </div>
                                                    </ui:fragment>                                                    
                                                </div>
                                            </ui:repeat>
                                        </ui:fragment>                                        
                                    </ui:fragment>
                                </ui:repeat>
                            </div>
                        </div>
                    </div>
                </ui:fragment>
            </ui:repeat>
        </div>    
    </ui:fragment>




</div>