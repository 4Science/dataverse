<div xmlns="http://www.w3.org/1999/xhtml"
     xmlns:h="http://java.sun.com/jsf/html"
     xmlns:f="http://java.sun.com/jsf/core"
     xmlns:ui="http://java.sun.com/jsf/facelets"
     xmlns:c="http://java.sun.com/jsp/jstl/core"
     xmlns:p="http://primefaces.org/ui">

    <!-- View Mode -->
    <ui:fragment rendered="${empty DatasetPage.editMode}">
        <div class="panel-group">
            <ui:repeat value="#{DatasetPage.datasetVersionUI.metadataBlocksForView.entrySet().toArray()}" var="metadataBlockVal" varStatus="block">
                <div class="panel panel-default">
                    <div data-toggle="collapse" data-target="#collapse#{block.index}" class="panel-heading">
                        #{metadataBlockVal.key.displayName}
                    </div>
                    <div id="collapse#{block.index}" class="collapse #{block.first?'in':''}">
                        <div class="panel-body">
                            <ui:repeat value="#{metadataBlockVal.value.entrySet().toArray()}" var="fieldMap">
                                <!-- Single value no child -->
                                <ui:repeat value="#{fieldMap.value}" var="fieldValues" rendered="#{!fieldMap.key.hasChildren and !fieldMap.key.hasParent and !fieldMap.key.allowMultiples}">
                                    <ui:fragment rendered="#{!empty fieldValues.strValue}">
                                        <div class="form-group">
                                            <label for="metadata_#{fieldValues.datasetField.name}" class="col-sm-3 control-label">
                                                <a href="#" data-toggle="tooltip" data-placement="auto right" class="tooltiplabel right" data-original-title="#{fieldValues.datasetField.description}" title="">
                                                    #{fieldValues.datasetField.title}
                                                </a>
                                            </label>                  
                                            <div class="col-sm-9">
                                                <h:outputText value="#{fieldValues.strValue}" rendered="#{empty DatasetPage.editMode  and !empty fieldValues.strValue}" />                                                                   
                                            </div>                                        
                                        </div>
                                    </ui:fragment>  
                                </ui:repeat>
                                <!-- Multiple value no child -->
                                <ui:fragment  rendered="#{!fieldMap.key.hasChildren and !fieldMap.key.hasParent and fieldMap.key.allowMultiples}">
                                    <div class="form-group">
                                        <label for="metadata_#{fieldMap.key.name}" class="col-sm-3 control-label">
                                            <a href="#" data-toggle="tooltip" data-placement="auto right" class="tooltiplabel right" data-original-title="#{fieldMap.key.description}" title="">
                                                #{fieldMap.key.title}
                                            </a>
                                        </label>  
                                        <div class="col-sm-7">
                                            <ui:repeat value="#{fieldMap.value}" var="fieldValues" varStatus="loop">
                                                <h:outputText value="#{loop.first?'':'; '}#{fieldValues.strValue}" rendered="#{!empty fieldValues.strValue}" />
                                            </ui:repeat> 
                                        </div> 
                                    </div>
                                </ui:fragment>
                                <!-- Parent / child -->
                                <ui:repeat value="#{fieldMap.value}" var="fieldValues" rendered="#{fieldMap.key.hasChildren}">
                                    <ui:fragment rendered="#{fieldValues.datasetField.hasChildren and !fieldValues.childEmpty}">
                                        <div class="form-group">
                                            <ui:fragment rendered="#{fieldValues.datasetField.hasChildren}">
                                                <label for="metadata_#{fieldValues.datasetField.name}" class="col-sm-3 control-label">
                                                    <a href="#" data-toggle="tooltip" data-placement="auto right" class="tooltiplabel right" data-original-title="#{fieldValues.datasetField.description}" title="">
                                                        #{fieldValues.datasetField.title}
                                                    </a>
                                                </label>                  
                                            </ui:fragment>
                                            <div class="col-sm-9">
                                                <!-- CHILDS -->
                                                <ui:repeat value="#{fieldValues.childDatasetFieldValues}" var="childVal" rendered="#{empty DatasetPage.editMode and fieldValues.datasetField.hasChildren}">                                                              
                                                    <ui:fragment rendered="#{!empty childVal.strValue and childVal.parentDatasetFieldValue == fieldValues}">
                                                        <div class="col-sm-6">
                                                            <label class="control-label" for="metadata_BLANK">
                                                                <a class="tooltiplabel right" data-original-title="#{childVal.datasetField.description}" data-placement="auto right" data-toggle="tooltip" href="#">#{childVal.datasetField.title}</a>                                                        
                                                            </label>
                                                            <div><h:outputText value="#{childVal.strValue}" rendered="#{childVal.parentDatasetFieldValue == fieldValues}"/> </div>
                                                        </div>
                                                    </ui:fragment>
                                                </ui:repeat>                                                                                                                                  
                                            </div> 
                                        </div>
                                    </ui:fragment>  
                                </ui:repeat>                                 
                            </ui:repeat>                                
                        </div>
                    </div>
                </div>
            </ui:repeat>
        </div>
    </ui:fragment>

    <!-- Edit Mode -->
    <ui:fragment rendered="${!empty DatasetPage.editMode}">
        <div class="panel-group">
            <ui:repeat value="#{DatasetPage.datasetVersionUI.metadataBlocksForEdit.entrySet().toArray()}" var="metadataBlockVal" varStatus="block">
                <ui:fragment rendered="#{(DatasetPage.editMode == 'METADATA' or metadataBlockVal.key.displayOnCreate)}">
                    <div class="panel panel-default">
                        <div data-toggle="collapse" data-target="#collapse#{block.index}" class="panel-heading">
                            #{metadataBlockVal.key.displayName}
                        </div>
                        <div id="collapse#{block.index}" class="collapse #{block.first || DatasetPage.editMode == 'CREATE'?'in':''}">
                            <div class="panel-body">
                                <ui:repeat value="#{metadataBlockVal.value.entrySet().toArray()}" var="fieldMap">
                                    <ui:fragment rendered="#{(DatasetPage.editMode == 'METADATA' or fieldMap.key.displayOnCreate) and !fieldMap.key.hasParent}">
                                        <!-- Everything except Select Multiple -->
                                        <ui:repeat value="#{fieldMap.value}" var="fieldValues" varStatus="valCount" rendered="#{!fieldMap.key.allowMultiples or !fieldMap.key.controlledVocabulary}">
                                            <ui:fragment rendered="#{(!fieldValues.datasetField.hasParent)}">
                                                <div class="form-group">
                                                    <ui:fragment rendered="#{!fieldValues.datasetField.hasParent}">
                                                        <label for="metadata_#{fieldValues.datasetField.name}" class="col-sm-3 control-label">
                                                            <a href="#" data-toggle="tooltip" data-placement="auto right" class="tooltiplabel right" data-original-title="#{fieldValues.datasetField.description}">
                                                                #{fieldValues.datasetField.title}
                                                            </a>
                                                            <h:outputText styleClass="glyphicon glyphicon-asterisk text-danger" value="" rendered="#{fieldValues.datasetField.required}" /> 
                                                        </label>                  
                                                    </ui:fragment>
                                                    <ui:fragment rendered="#{!fieldValues.datasetField.hasChildren and !fieldValues.datasetField.hasParent}">
                                                        <ui:include src="datasetFieldForEditFragment.xhtml">
                                                            <ui:param name="fieldValues" value="#{fieldValues}"/>
                                                        </ui:include>
                                                    </ui:fragment>

                                                    <ui:fragment rendered="#{fieldValues.datasetField.hasChildren}">
                                                        <div class="form-group col-sm-7">
                                                            <!-- CHILDS -->
                                                            <ui:repeat value="#{fieldValues.childDatasetFieldValues}" var="childVal" rendered="#{!fieldValues.datasetField.hasChildren}">                                                              
                                                                <div class="col-sm-6">
                                                                    <label class="control-label" for="metadata_BLANK">
                                                                        <a class="tooltiplabel right" data-original-title="#{childVal.datasetField.description}" data-placement="auto right" data-toggle="tooltip" href="#">#{childVal.datasetField.title}</a>
                                                                    </label>
                                                                    <div><h:outputText value="#{childVal.strValue}" rendered="#{childVal.parentDatasetFieldValue == fieldValues}"/></div>
                                                                </div>
                                                            </ui:repeat>                                                                

                                                            <ui:repeat value="#{fieldValues.childDatasetFieldValues}" var="childVal" rendered="#{fieldValues.datasetField.hasChildren}">
                                                                <ui:include src="datasetFieldForEditFragment.xhtml">
                                                                    <ui:param name="fieldValues" value="#{childVal}"/>
                                                                    <ui:param name="includeTitle" value="true"/>
                                                                </ui:include>
                                                            </ui:repeat>
                                                        </div>
                                                    </ui:fragment>

                                                    <!-- Add / Remove buttons -->
                                                    <ui:fragment rendered="#{fieldValues.datasetField.allowMultiples and !fieldValues.datasetField.controlledVocabulary}">
                                                        <div class="col-xs-2">
                                                            <p:commandButton styleClass="btn btn-default btn-sm" style="#{fieldValues.datasetField.hasChildren ? 'margin:1.8em 1em 0 0;' : 'margin:0 1em 0 0;'}"  
                                                                             title="Add Record" value="&lt;span class='glyphicon glyphicon-plus'&gt;&lt;/span&gt;" escape="false" 
                                                                             actionListener="#{DatasetPage.addGeneralRecord(fieldValues)}" update="@all">
                                                            </p:commandButton>
                                                            <p:commandButton styleClass="btn btn-default btn-sm" style="#{fieldValues.datasetField.hasChildren ? 'margin-top:1.8em;' : ''}"  
                                                                             title="Delete Record" value="&lt;span class='glyphicon glyphicon-minus'&gt;&lt;/span&gt;" 
                                                                             rendered="#{valCount.index gt 0}"
                                                                             escape="false" actionListener="#{DatasetPage.deleteGeneralRecord(fieldValues)}" update="@all">
                                                                <f:setPropertyActionListener target="#{DatasetPage.selectedTabIndex}" value="0" />
                                                            </p:commandButton>
                                                        </div>
                                                    </ui:fragment>
                                                </div>
                                            </ui:fragment>
                                        </ui:repeat>
                                        <!-- For fields that Allow Multiples with Controlled Vocab -->
                                        <ui:fragment rendered="#{fieldMap.key.allowMultiples and fieldMap.key.controlledVocabulary and !fieldValues.datasetField.hasParent}">
                                            <div class="form-group">
                                                <label for="metadata_#{fieldMap.key.name}" class="col-sm-3 control-label">
                                                    <a href="#" data-toggle="tooltip" data-placement="auto right" class="tooltiplabel right" data-original-title="#{fieldMap.key.description}" title="">
                                                        #{fieldMap.key.title}
                                                    </a>
                                                    <h:outputText styleClass="glyphicon glyphicon-asterisk text-danger" value="" rendered="#{fieldMap.key.required}" /> 
                                                </label>
                                                <div class="col-sm-6">
                                                    <h:selectManyListbox value="#{fieldMap.value.get(0).controlledVocabularyValues}" converter="controlledVocabularyValueConverter" styleClass="form-control">
                                                        <f:selectItems value="#{fieldMap.key.controlledVocabularyValues}" var="cvv" itemLabel="#{cvv.strValue}" itemValue="#{cvv}" />                                                         
                                                    </h:selectManyListbox>
                                                </div>
                                            </div>
                                        </ui:fragment>

                                    </ui:fragment>

                                </ui:repeat>
                            </div>
                        </div>
                    </div>
                </ui:fragment>
            </ui:repeat>
        </div>    
    </ui:fragment>




</div>