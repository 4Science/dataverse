<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:c="http://java.sun.com/jsp/jstl/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:o="http://omnifaces.org/ui"
                xmlns:jsf="http://xmlns.jcp.org/jsf"
                xmlns:iqbs="http://xmlns.jcp.org/jsf/composite/iqbs">
    <!--MAD: Provenance popup, most content from metadata/tags atm. Going to make it look like the mockup and then change it...-->
    <p:dialog id="editProvenancePopup" styleClass="smallPopUp" header="#{bundle['file.editProvenanceDialog']}" widgetVar="editProvenancePopup" modal="true">
        <!-- MAD: I added a form tag here and it caused (non-provenance) file upload to break 
                I really shouldn't be using the overarching form but I also don't know how to get around it... -->
        <p:outputPanel id="provPopupOutput" class="form-horizontal"> <!-- <div class="form-horizontal" > jsf:rendered="# {!(empty EditDatafilesPage.fileMetadataSelectedForTagsPopup)}">-->
                <div class="form-group text-left">
                    <div class="col-sm-12">
                        <p class="help-block">#{bundle['file.editProvenanceDialog.tip']}</p>
                    </div>
                </div>
                <div class="form-group text-left">
                    <label for="provenanceBundle" class="col-sm-4 control-label">
                        #{bundle['file.editProvenanceDialog.bundleFile']}
                    </label>
                    <div class="col-sm-8">
                        <!--MAD: upload file ui fragment from above -->
                        <!--MAD: There was a help block in here. When I removed it the background highlighting decided to creep up -->
                        <ui:fragment id="provUploadFragment"> <!--rendered="# {datasetPage || EditDatafilesPage.showFileUploadFragment()}"> -->
                            <ui:fragment rendered="#{null == provenanceUploadFragmentBean.jsonFileName}">
                                <p class="help-block">#{bundle['file.editProvenanceDialog.bundleFile.instructions']}</p>
                                <p:fileUpload id="provUpload" 
                                              styleClass="margin-bottom"
                                              dragDropSupport="true"
                                              auto="true"
                                              multiple="false"
                                              allowTypes="/(\.|\/)(json)$/"
                                              fileUploadListener="#{provenanceUploadFragmentBean.handleFileUpload}" 
                                              update="provPopupOutput" 
                                              label="#{bundle['file.editProvenanceDialog.selectToAddBtn']}"
                                              oncomplete="bind_bsui_components();PF('provUpload').hide();"
                                              fileLimit="1" 
                                              invalidSizeMessage="#{bundle['file.edit.error.file_exceeds_limit']}"/>
                                <script>
                                    function uploadStarted() {
                                        $('button[id$="provUploadStarted"]').trigger('click');
                                    }
                                    function uploadFinished(fileupload) {                    
                                        if (fileupload.files.length === 0) {
                                            $('button[id$="AllUploadsFinished"]').trigger('click');
                                            //alert("all uploads finished");
                                        }
                                    }
                                </script>
                            </ui:fragment>
                            <ui:fragment rendered="#{null != provenanceUploadFragmentBean.jsonFileName}">
                                <!-- need to conditionally load the json here. I have no idea how to load this aux file -->
                                <div id="provFileText" class="col-sm-5 text-success">
                                    <div class="margin-top-half">
                                        <span class="glyphicon glyphicon-ok"></span> #{bundle['file.editProvenanceDialog.uploadSuccess']}
                                    </div>
                                </div>
                                <div class="col-sm-7 inline-buttons">
                                    <div class="button-block">
                                        <p:commandButton styleClass="btn btn-default" id="editProvenanceJsonPreview" value="#{bundle.preview}"/>
                                        <p:commandButton styleClass="btn btn-default" id="editProvenanceJsonRemove" value="#{bundle.remove}" update="provPopupOutput" actionListener="#{provenanceUploadFragmentBean.updateJsonRemoveState()}" oncomplete="PF('provUpload').hide();"/>
                                    </div>
                                </div>
                            </ui:fragment>
                            <p:message for="provUpload" id="provUploadMessage" display="text" />
                            <!--oncomplete="javascript:dataset_fileupload_rebind();uploadWidgetDropMsg();uploadFinished(PF('fileUploadWidget'));" -->
                            <!--<p:commandButton id="AllUploadsFinished" action="# {EditDatafilesPage.uploadFinished()}" update="datasetForm:fileUpload,datasetForm:dropBoxUserButton,datasetForm:uploadMessage,datasetForm:filesTable" style="display:none"/> 
                            -->
                        </ui:fragment>
                    </div>
                </div>
                <div class="form-group text-left">
                    <div class="col-sm-12">
                        <p class="help-block">#{bundle['file.editProvenanceDialog.description.tip']}</p>
                    </div>
                </div>
                <div class="form-group text-left">
                    <label for="provenanceAddDescription" class="col-sm-4 control-label">
                        #{bundle['file.editProvenanceDialog.description']}
                    </label>
                    <div class="col-sm-8">
                        <div class="row form-inline">
                            <div class="col-sm-12">
                                <p:inputTextarea id="provenanceFreeform" styleClass="form-control" immediate="true" rows="2" cols="40" value="#{provenanceUploadFragmentBean.freeformTextInput}" 
                                                placeholder="#{bundle['file.editProvenanceDialog.description.placeholder']}"
                                                onkeypress="if (event.keyCode == 13) {
                                                        return false;
                                                    }"
                                                style="width:98%; margin-top:.5em;"/>
                                <p:message for="provenanceFreeform" display="text" />
                            </div>
                        </div>
                    </div>
                </div>
            <div class="button-block">
                <p:commandButton styleClass="btn btn-default" id="editProvenancePopupSaveButton" value="#{bundle.saveChanges}" onclick="PF('editProvenancePopup').hide();PF('confirmProvenancePopup').show();"/>
                <p:commandButton styleClass="btn btn-default" id="editProvenancePopupCancelButton" value="#{bundle.cancel}" onclick="PF('editProvenancePopup').hide();"  />
            </div>
        </p:outputPanel>
    </p:dialog>
    <p:dialog id="confirmProvenancePopup" header="#{bundle['file.confirmProvenanceDialog']}" modal="true" visible="false" styleClass="smallPopUp" widgetVar="confirmProvenancePopup">
        <div class="form-group text-left text-warning">
            <span class="glyphicon glyphicon-warning-sign"></span> <h:outputText value=" #{bundle['file.confirmProvenanceDialog.tip']}"/>
        </div>
        <div class="button-block">
            <p:commandButton styleClass="btn btn-default" id="confirmProvenancePopupSaveButton" value="#{bundle.saveChanges}" oncomplete="PF('confirmProvenancePopup').hide();" actionListener="#{provenanceUploadFragmentBean.saveContent()}"/>
            <p:commandButton styleClass="btn btn-default" id="confirmProvenancePopupCancelButton" value="#{bundle.cancel}" onclick="PF('editProvenancePopup').show();PF('confirmProvenancePopup').hide();"/>
        </div>
    </p:dialog>
</ui:composition>