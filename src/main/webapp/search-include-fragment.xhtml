<div xmlns="http://www.w3.org/1999/xhtml"
     xmlns:h="http://java.sun.com/jsf/html"
     xmlns:f="http://java.sun.com/jsf/core"
     xmlns:ui="http://java.sun.com/jsf/facelets"
     xmlns:c="http://java.sun.com/jsp/jstl/core"
     xmlns:p="http://primefaces.org/ui"
     xmlns:o="http://omnifaces.org/ui"
     xmlns:jsf="http://xmlns.jcp.org/jsf">

    <!-- Search Form -->
    <p:panel styleClass="panelLayoutBlock panelSerchForm" rendered="#{showSearch == true}">
        <p:panelGrid styleClass="panelgridLayoutTable" columns="2" columnClasses="text-left,text-right">
            <ui:fragment>
                <h:form>
                    <p:focus/>
                    <!--autocomplete disabled for now, too buggy: https://redmine.hmdc.harvard.edu/issues/3447#note-2 -->
                    <!--<p:autoComplete id="autoCompleteSearch" size="40" value="SearchIncludeFragment.query" completeMethod="autoCompleteBean.complete" style="margin-right:1em;"/>-->
                    <p:inputText id="formerAutoCompleteSearch" size="40" value="#{SearchIncludeFragment.query}" onkeypress="if (event.keyCode == 13) { submitsearch(); return false; }"/>
                    <p:watermark for="formerAutoCompleteSearch" value="#{bundle['dataverse.search.input.watermark']}"/>
                    <p:commandLink id="searchbutton" styleClass="btn btn-default" action="#{SearchIncludeFragment.searchRedirect(dataverseRedirectPage)}">
                        <span class="glyphicon glyphicon-search"/> #{bundle['dataverse.search.btn.find']}
                    </p:commandLink>
                    <p:remoteCommand name="submitsearch" action="#{SearchIncludeFragment.searchRedirect(dataverseRedirectPage)}"/>                  
                    <h:outputLink id="advsearchlink" value="/search/advanced.xhtml" target="#{showFacets == true ? '_self' : '_blank'}" rendered="#{showAdvancedSearchLink}">
                      <f:param name="dataverseIdentifier" value="#{SearchIncludeFragment.dataverse.alias}"/>
                        <h:outputText value="#{bundle['dataverse.search.advancedSearch']}"/>
                        <!--<f:param name="q" value="#{SearchIncludeFragment.query}" disable="#{empty SearchIncludeFragment.query}"/>-->
                    </h:outputLink>
                </h:form>
            </ui:fragment>
            
            <o:importFunctions type="edu.harvard.iq.dataverse.authorization.groups.impl.builtin.AuthenticatedUsers" />
            <ui:fragment rendered="#{!dataverseSession.user.authenticated and (permissionServiceBean.userOn(AuthenticatedUsers:get(),SearchIncludeFragment.dataverse).canIssueCommand('CreateDataverseCommand')
                                     or permissionServiceBean.userOn(AuthenticatedUsers:get(),SearchIncludeFragment.dataverse).canIssueCommand('CreateDatasetCommand'))}">
                
                <div class="pull-right">
                    <button type="button" class="btn btn-default" onclick="addData_popup.show()">
                        <span class="glyphicon glyphicon-plus"/> #{bundle['dataverse.results.btn.addData']}
                    </button>
                </div>
                <p:confirmDialog header="#{bundle['dataverse.results.dialog.addDataGuest.header']}" styleClass="text-left" widgetVar="addData_popup">                                           
                    <f:facet name="message">
                        #{bundle['dataverse.results.dialog.addDataGuest.prefix']}
                        <ui:fragment rendered="#{dataverseHeaderFragment.signupAllowed}">
                            <a href="/dataverseuser.xhtml#{dataverseHeaderFragment.loginRedirectPage}&amp;editMode=CREATE">#{bundle.signup}</a> 
                            #{bundle['dataverse.results.dialog.addDataGuest.conjunction']} 
                        </ui:fragment>
                        <a href="/loginpage.xhtml#{dataverseHeaderFragment.loginRedirectPage}">#{bundle.login}</a> 
                        #{bundle['dataverse.results.dialog.addDataGuest.suffix']}
                    </f:facet>
                </p:confirmDialog>  
            </ui:fragment>

            <ui:fragment rendered="#{dataverseSession.user.authenticated and (permissionServiceBean.on(SearchIncludeFragment.dataverse).canIssueCommand('CreateDataverseCommand')
                                     or permissionServiceBean.on(SearchIncludeFragment.dataverse).canIssueCommand('CreateDatasetCommand'))}">
                <h:form id="shareForm">
                    <div class="btn-group">
                        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                            <span class="glyphicon glyphicon-plus"/> #{bundle['dataverse.results.btn.addData']} <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu pull-right text-left" role="menu">
                            <ui:fragment rendered="#{permissionServiceBean.on(SearchIncludeFragment.dataverse).canIssueCommand('CreateDataverseCommand') }">
                                <li><a href="/dataverse.xhtml?ownerId=#{SearchIncludeFragment.dataverse.id}">#{bundle['dataverse.results.btn.addData.newDataverse']}</a></li>
                            </ui:fragment>
                            <ui:fragment rendered="#{permissionServiceBean.on(SearchIncludeFragment.dataverse).canIssueCommand('CreateDatasetCommand') }">
                                <li><a href="/dataset.xhtml?ownerId=#{SearchIncludeFragment.dataverse.id}">#{bundle['dataverse.results.btn.addData.newDataset']}</a></li>
                            </ui:fragment>
                        </ul>
                    </div>
                </h:form>
            </ui:fragment>
        </p:panelGrid>
    </p:panel>
    <!-- Search Results -->
    <div class="panel panel-default">
        <div class="panel-body clearfix">
            <ui:fragment rendered="#{!SearchIncludeFragment.solrIsDown}">
                <ui:fragment rendered="#{showFacets}">
                    <div id="dv-sidecolumn">
                        <!--TYPE FACET (DATAVERSES, DATASETS, FILES)-->
                        <h:form id="facetType">
                            <!--DATAVERSE TOGGLE-->
                            <div class="clearfix">
                                <h:outputLink styleClass="facetTypeChBox facetLink #{SearchIncludeFragment.selectedTypesList.contains('dataverses') ? 'facetSelected': ''}" disabled="#{SearchIncludeFragment.getNewSelectedTypes('dataverses') == null}">
                                    <f:param name="id" value="#{SearchIncludeFragment.dataverseId}"/>
                                    <f:param name="q" value="#{SearchIncludeFragment.query}"/>
                                    <f:param name="types" value="#{SearchIncludeFragment.getNewSelectedTypes('dataverses')}"/>
                                    <c:forEach items="#{SearchIncludeFragment.filterQueries}" var="clickedFilterQuery" varStatus="status">
                                        <f:param name="fq#{status.index}" value='#{clickedFilterQuery}'/>
                                    </c:forEach>
                                    <f:param name="sort" value="#{SearchIncludeFragment.sortField}"/>
                                    <f:param name="order" value="#{SearchIncludeFragment.sortOrder}"/>
                                    <f:param name="page" value="1"/>
                                    <p:selectBooleanCheckbox value="#{SearchIncludeFragment.selectedTypesList.contains('dataverses') ? true : false}" disabled="#{SearchIncludeFragment.getNewSelectedTypes('dataverses') == null ? true : false}"/>
                                </h:outputLink>
                                <!--DATAVERSES ONLY-->
                                <h:outputLink disabled="#{false}" styleClass="facetTypeLink #{SearchIncludeFragment.selectedTypesList.contains('dataverses') ? 'facetSelected': ''}">
                                    <f:param name="id" value="#{SearchIncludeFragment.dataverseId}"/>
                                    <f:param name="q" value="#{SearchIncludeFragment.query}"/>
                                    <f:param name="types" value="dataverses"/>
                                    <c:forEach items="#{SearchIncludeFragment.filterQueries}" var="clickedFilterQuery" varStatus="status">
                                        <f:param name="fq#{status.index}" value='#{clickedFilterQuery}'/>
                                    </c:forEach>
                                    <f:param name="sort" value="#{SearchIncludeFragment.sortField}"/>
                                    <f:param name="order" value="#{SearchIncludeFragment.sortOrder}"/>
                                    <f:param name="page" value="1"/>
                                    
                                    <i class="icon-dataverse text-icon-inline"></i>
                                    
                                    <h:outputText value="#{bundle['dataverse.results.types.dataverses']} (#{SearchIncludeFragment.facetCountDataverses})" styleClass="facetTypeDataverse"/>
                                </h:outputLink>
                            </div>
                            <!--DATASETS TOGGLE-->
                            <div class="clearfix">
                                <h:outputLink styleClass="facetTypeChBox facetLink #{SearchIncludeFragment.selectedTypesList.contains('datasets') ? 'facetSelected': ''}" disabled="#{SearchIncludeFragment.getNewSelectedTypes('datasets') == null}">
                                    <f:param name="id" value="#{SearchIncludeFragment.dataverseId}"/>
                                    <f:param name="q" value="#{SearchIncludeFragment.query}"/>
                                    <f:param name="types" value="#{SearchIncludeFragment.getNewSelectedTypes('datasets')}"/>
                                    <c:forEach items="#{SearchIncludeFragment.filterQueries}" var="clickedFilterQuery" varStatus="status">
                                        <f:param name="fq#{status.index}" value='#{clickedFilterQuery}'/>
                                    </c:forEach>
                                    <f:param name="sort" value="#{SearchIncludeFragment.sortField}"/>
                                    <f:param name="order" value="#{SearchIncludeFragment.sortOrder}"/>
                                    <f:param name="page" value="1"/>
                                    <p:selectBooleanCheckbox value="#{SearchIncludeFragment.selectedTypesList.contains('datasets') ? true : false}" disabled="#{SearchIncludeFragment.getNewSelectedTypes('datasets') == null ? true : false}"/>
                                </h:outputLink>
                                <!--DATASETS ONLY-->
                                <h:outputLink disabled="#{false}" styleClass="facetTypeLink #{SearchIncludeFragment.selectedTypesList.contains('datasets') ? 'facetSelected': ''}">
                                    <f:param name="id" value="#{SearchIncludeFragment.dataverseId}"/>
                                    <f:param name="q" value="#{SearchIncludeFragment.query}"/>
                                    <f:param name="types" value="datasets"/>
                                    <c:forEach items="#{SearchIncludeFragment.filterQueries}" var="clickedFilterQuery" varStatus="status">
                                        <f:param name="fq#{status.index}" value='#{clickedFilterQuery}'/>
                                    </c:forEach>
                                    <f:param name="sort" value="#{SearchIncludeFragment.sortField}"/>
                                    <f:param name="order" value="#{SearchIncludeFragment.sortOrder}"/>
                                    <f:param name="page" value="1"/>
                                    
                                    <i class="icon-dataset text-icon-inline"></i>
                                    
                                    <h:outputText value="#{bundle['dataverse.results.types.datasets']} (#{SearchIncludeFragment.facetCountDatasets})" styleClass="facetTypeDataset"/>
                                </h:outputLink>
                            </div>
                            <!--FILES TOGGLE-->
                            <div class="clearfix">
                                <h:outputLink styleClass="facetTypeChBox facetLink #{SearchIncludeFragment.selectedTypesList.contains('files') ? 'facetSelected': ''}" disabled="#{SearchIncludeFragment.getNewSelectedTypes('files') == null}">
                                    <f:param name="id" value="#{SearchIncludeFragment.dataverseId}"/>
                                    <f:param name="q" value="#{SearchIncludeFragment.query}"/>
                                    <f:param name="types" value="#{SearchIncludeFragment.getNewSelectedTypes('files')}"/>
                                    <c:forEach items="#{SearchIncludeFragment.filterQueries}" var="clickedFilterQuery" varStatus="status">
                                        <f:param name="fq#{status.index}" value='#{clickedFilterQuery}'/>
                                    </c:forEach>
                                    <f:param name="sort" value="#{SearchIncludeFragment.sortField}"/>
                                    <f:param name="order" value="#{SearchIncludeFragment.sortOrder}"/>
                                    <f:param name="page" value="1"/>
                                    <p:selectBooleanCheckbox value="#{SearchIncludeFragment.selectedTypesList.contains('files') ? true : false}" disabled="#{SearchIncludeFragment.getNewSelectedTypes('files') == null ? true : false}"/>
                                </h:outputLink>
                                <!--FILES ONLY-->
                                <h:outputLink disabled="#{false}" styleClass="facetTypeLink #{SearchIncludeFragment.selectedTypesList.contains('files') ? 'facetSelected': ''}">
                                    <f:param name="id" value="#{SearchIncludeFragment.dataverseId}"/>
                                    <f:param name="q" value="#{SearchIncludeFragment.query}"/>
                                    <f:param name="types" value="files"/>
                                    <c:forEach items="#{SearchIncludeFragment.filterQueries}" var="clickedFilterQuery" varStatus="status">
                                        <f:param name="fq#{status.index}" value='#{clickedFilterQuery}'/>
                                    </c:forEach>
                                    <f:param name="sort" value="#{SearchIncludeFragment.sortField}"/>
                                    <f:param name="order" value="#{SearchIncludeFragment.sortOrder}"/>
                                    <f:param name="page" value="1"/>
                                    
                                    <i class="icon-file text-icon-inline"></i>
                                    
                                    <h:outputText value="#{bundle['dataverse.results.types.files']} (#{SearchIncludeFragment.facetCountFiles})" styleClass="facetTypeFile"/>
                                </h:outputLink>
                            </div>
                        </h:form>
                        
                        <!--NON-TYPE FACETS-->
                        <h:form id="facetCategoryForm" rendered="#{SearchIncludeFragment.searchResultsCount > 0}">
                            <p:dataList id="facetCategoryList" value="#{SearchIncludeFragment.facetCategoryList}" var="facetCategory">
                                <h:outputText value="#{facetCategory.friendlyName}" styleClass="facetCategoryName"/>
                                <p:dataList value="#{facetCategory.facetLabel}" var="facetLabel" rows="#{SearchIncludeFragment.getNumberOfFacets(facetCategory.name,5)}">
                                    <h:outputLink rendered="#{!SearchIncludeFragment.filterQueries.contains(facetLabel.filterQuery)}" styleClass="facetLink">
                                        <h:outputText value="#{facetLabel.name} (#{facetLabel.count})"/>
                                        <f:param name="id" value="#{SearchIncludeFragment.dataverseId}"/>
                                        <f:param name="q" value="#{SearchIncludeFragment.query}"/>
                                        <f:param name="fq#{SearchIncludeFragment.filterQueries.size()}" value="#{facetLabel.filterQuery}"/>
                                        <c:forEach items="#{SearchIncludeFragment.filterQueries}" var="clickedFilterQuery" varStatus="status">
                                            <f:param name="fq#{status.index}" value='#{clickedFilterQuery}'/>
                                        </c:forEach>
                                        <f:param name="types" value="#{SearchIncludeFragment.selectedTypesString}"/>
                                        <f:param name="sort" value="#{SearchIncludeFragment.sortField}"/>
                                        <f:param name="order" value="#{SearchIncludeFragment.sortOrder}"/>
                                    </h:outputLink>

                                    <h:outputLink rendered="#{SearchIncludeFragment.filterQueries.contains(facetLabel.filterQuery)}" styleClass="facetLink facetSelected">
                                        <h:outputText value="#{facetLabel.name} (#{facetLabel.count})"/>
                                        <span class="glyphicon glyphicon-remove"></span>
                                        <f:param name="id" value="#{SearchIncludeFragment.dataverseId}"/>
                                        <f:param name="q" value="#{SearchIncludeFragment.query}"/>
                                        <c:forEach items="#{SearchIncludeFragment.filterQueries}" var="clickedFilterQuery" varStatus="status">
                                            <f:param name="fq#{status.index}" value='#{clickedFilterQuery}' disable="#{clickedFilterQuery == facetLabel.filterQuery}"/>
                                        </c:forEach>
                                        <f:param name="types" value="#{SearchIncludeFragment.selectedTypesString}"/>
                                        <f:param name="sort" value="#{SearchIncludeFragment.sortField}"/>
                                        <f:param name="order" value="#{SearchIncludeFragment.sortOrder}"/>
                                    </h:outputLink>
                                </p:dataList>
                                <ui:fragment rendered="#{facetCategory.name != SearchIncludeFragment.searchFieldType and facetCategory.name != SearchIncludeFragment.searchFieldSubtree}">
                                    <p:panelGrid styleClass="facetsMoreLess" columns="2" rendered="#{(SearchIncludeFragment.getNumberOfFacets(facetCategory.name,5) lt facetCategory.facetLabel.size()) or (SearchIncludeFragment.getNumberOfFacets(facetCategory.name,5) gt 5)}">
                                        <ui:fragment>
                                            <p:commandLink actionListener="#{SearchIncludeFragment.incrementFacets(facetCategory.name,-5)}" update="facetCategoryList" rendered="#{SearchIncludeFragment.getNumberOfFacets(facetCategory.name,5) gt 5}">#{bundle.less}</p:commandLink>
                                        </ui:fragment>
                                        <ui:fragment>
                                            <p:commandLink actionListener="#{SearchIncludeFragment.incrementFacets(facetCategory.name,5)}" update="facetCategoryList" rendered="#{SearchIncludeFragment.getNumberOfFacets(facetCategory.name,5) lt facetCategory.facetLabel.size()}">#{bundle.less}</p:commandLink>
                                        </ui:fragment>  
                                    </p:panelGrid>
                                </ui:fragment>
                            </p:dataList>
                        </h:form>
                    </div>
                </ui:fragment>
                <ui:param name="dataversePage" value="#{dataverseLinksStayOnPage == true ? '' : '/dataverse.xhtml' }"/>
                <div id="dv-maincolumn" class="#{showFacets == true ? 'showfacets' : 'nofacets'}">
                    <!--DEBUG BEGIN-->
                    <ui:fragment rendered="#{SearchIncludeFragment.debug}">
                        <div style="background-color: lightgray">
                            <tt>
                                <h:outputText value="mode:#{SearchIncludeFragment.mode} "/>
                                <h:outputText value="sort=#{SearchIncludeFragment.sortField}:#{SearchIncludeFragment.sortOrder}"/><br/>
                                <h:outputText value="#{SearchIncludeFragment.filterQueriesDebug}"/><br/>
                                <h:outputText value="solrIsDown=#{SearchIncludeFragment.solrIsDown}"/><br/>
                                <h:outputText value="errorFromSolr: #{SearchIncludeFragment.errorFromSolr}" rendered="#{SearchIncludeFragment.errorFromSolr != null}"/>
                            </tt>
                        </div>
                    </ui:fragment>
                    <!--DEBUG END-->

                    <ui:fragment rendered="#{SearchIncludeFragment.searchResultsList.size() == 0}">
                        <div id="emptyResults" class="emptyResults bg-warning">
                            <ui:fragment rendered="#{SearchIncludeFragment.mode == SearchIncludeFragment.searchModeString}">
                                <!--THIS IS EMPTY / SEARCH-->
                                <ui:fragment rendered="#{SearchIncludeFragment.facetCountDataverses eq 0 and SearchIncludeFragment.facetCountDatasets eq 0 and SearchIncludeFragment.facetCountFiles eq 0}">
                                  <!--SEARCH ZERO COUNTS-->
                                  <p>There are no dataverses, datasets, or files that match your search. Please try a new search by using other or broader terms. You can also check out the <a href="/guides/user/find-use-data.html" target="_blank">search guide</a> for tips.</p>
                                </ui:fragment>
                                <ui:fragment rendered="#{SearchIncludeFragment.facetCountDataverses gt 0 or SearchIncludeFragment.facetCountDatasets gt 0 and SearchIncludeFragment.facetCountFiles gt 0}">
                                  <!--SEARCH HIDDEN-->
                                  <p>There are no search results based on how you have narrowed your search. You can check out the <a href="/guides/user/find-use-data.html" target="_blank">search guide</a> for tips.</p>
                                </ui:fragment>
                                <ui:fragment rendered="#{SearchIncludeFragment.errorFromSolr != null}">
                                    <p>
                                        <a data-toggle="collapse" data-parent="#emptyResults" href="#technicalDetails" aria-expanded="true" aria-controls="technicalDetails">[+] #{bundle['dataverse.results.empty.link.technicalDetails']}</a>
                                    </p>
                                    <div id="technicalDetails" class="collapse">
                                        <pre><h:outputText value="#{SearchIncludeFragment.errorFromSolr}"/></pre>
                                    </div>
                                </ui:fragment>
                            </ui:fragment>
                            <ui:fragment rendered="#{!dataverseSession.user.authenticated and SearchIncludeFragment.mode == SearchIncludeFragment.browseModeString}">
                                <!--THIS IS EMPTY / BROWSE / GUEST-->
                                <ui:fragment rendered="#{SearchIncludeFragment.facetCountDataverses eq 0 and SearchIncludeFragment.facetCountDatasets eq 0 and SearchIncludeFragment.facetCountFiles eq 0}">
                                  <!--BROWSE GUEST ZERO COUNTS-->
                                  <p>
                                      <h:outputFormat value="#{bundle['dataverse.results.empty.browse.guest.zero']}" escape="false">
                                          <f:param value="#{dataverseHeaderFragment.loginRedirectPage}"/>
                                      </h:outputFormat>
                                  </p>
                                </ui:fragment>
                                <ui:fragment rendered="#{SearchIncludeFragment.facetCountDataverses gt 0 or SearchIncludeFragment.facetCountDatasets gt 0 or SearchIncludeFragment.facetCountFiles gt 0}">
                                  <!--BROWSE GUEST HIDDEN-->
                                  <p>
                                      <h:outputFormat value="#{bundle['dataverse.results.empty.browse.guest.hidden']}" escape="false">
                                          <f:param value="#{dataverseHeaderFragment.loginRedirectPage}"/>
                                      </h:outputFormat>
                                  </p>
                                </ui:fragment>
                            </ui:fragment>
                            <ui:fragment rendered="#{dataverseSession.user.authenticated and !(permissionServiceBean.on(SearchIncludeFragment.dataverse).canIssueCommand('CreateDataverseCommand') or permissionServiceBean.on(SearchIncludeFragment.dataverse).canIssueCommand('CreateDatasetCommand')) and SearchIncludeFragment.mode == SearchIncludeFragment.browseModeString}">
                                <!--THIS IS EMPTY / BROWSE / LOGGED IN / NO PERMS-->
                                <ui:fragment rendered="#{SearchIncludeFragment.facetCountDataverses eq 0 and SearchIncludeFragment.facetCountDatasets eq 0 and SearchIncludeFragment.facetCountFiles eq 0}">
                                  <!--BROWSE NO_ADD_BUTTON ZERO COUNTS-->
                                  <p>#{bundle['dataverse.results.empty.browse.loggedin.noperms.zero']}</p>
                                </ui:fragment>
                                <ui:fragment rendered="#{SearchIncludeFragment.facetCountDataverses gt 0 or SearchIncludeFragment.facetCountDatasets gt 0 or SearchIncludeFragment.facetCountFiles gt 0}">
                                  <!--BROWSE NO_ADD_BUTTON HIDDEN-->
                                  <p>#{bundle['dataverse.results.empty.browse.loggedin.noperms.hidden']}</p>
                                </ui:fragment>
                            </ui:fragment>
                            <ui:fragment rendered="#{dataverseSession.user.authenticated and (permissionServiceBean.on(SearchIncludeFragment.dataverse).canIssueCommand('CreateDataverseCommand') or permissionServiceBean.on(SearchIncludeFragment.dataverse).canIssueCommand('CreateDatasetCommand')) and SearchIncludeFragment.mode == SearchIncludeFragment.browseModeString}">
                                <!--THIS IS EMPTY / BROWSE / LOGGED IN / PERMS-->
                                <ui:fragment rendered="#{SearchIncludeFragment.facetCountDataverses eq 0 and SearchIncludeFragment.facetCountDatasets eq 0 and SearchIncludeFragment.facetCountFiles eq 0}">
                                  <!--BROWSE CAN_ADD ZERO COUNTS-->
                                  <p>#{bundle['dataverse.results.empty.browse.loggedin.perms.zero']}</p>
                                </ui:fragment>
                                <ui:fragment rendered="#{SearchIncludeFragment.facetCountDataverses gt 0 or SearchIncludeFragment.facetCountDatasets gt 0 or SearchIncludeFragment.facetCountFiles gt 0}">
                                  <!--BROWSE CAN_ADD HIDDEN-->
                                  <p>#{bundle['dataverse.results.empty.browse.loggedin.perms.hidden']}</p>
                                </ui:fragment>
                            </ui:fragment>
                        </div>
                    </ui:fragment>
                    <ui:fragment>
                        <ui:fragment rendered="#{!empty SearchIncludeFragment.filterQueries}">
                            <div id="resultsFacetsTopBlock">
                                <ui:repeat value="#{SearchIncludeFragment.filterQueries}" var="filterQuery">
                                    <ui:param name="friendlyNames" value="#{SearchIncludeFragment.getFriendlyNamesFromFilterQuery(filterQuery)}"/>
                                    <h:outputLink styleClass="facetLink facetSelected">
                                        <h:outputText value="#{friendlyNames.get(0)}: #{friendlyNames.get(1)}"/> <span class="glyphicon glyphicon-remove"></span>
                                        <f:param name="id" value="#{SearchIncludeFragment.dataverseId}"/>
                                        <f:param name="q" value="#{SearchIncludeFragment.query}"/>
                                        <c:forEach items="#{SearchIncludeFragment.filterQueries}" var="clickedFilterQuery" varStatus="status">
                                            <f:param name="fq#{status.index}" value='#{clickedFilterQuery}' disable="#{clickedFilterQuery == filterQuery}"/>
                                        </c:forEach>
                                        <f:param name="types" value="#{SearchIncludeFragment.selectedTypesString}"/>
                                        <f:param name="sort" value="#{SearchIncludeFragment.sortField}"/>
                                        <f:param name="order" value="#{SearchIncludeFragment.sortOrder}"/>
                                    </h:outputLink>
                                </ui:repeat>
                            </div>
                        </ui:fragment>

                        <ui:fragment rendered="#{SearchIncludeFragment.searchResultsCount > 0}">
                            <div id="resultsCountPaginatorBlock" class="clearfix">
                                <!-- RESULTS COUNT -->
                                <div class="results-count pull-left">
                                    <h:outputText value="#{SearchIncludeFragment.paginationGuiStart} #{bundle['dataverse.results.count.to']} #{SearchIncludeFragment.paginationGuiEnd} #{bundle['dataverse.results.count.of']} "/>
                                    <h:outputFormat value="#{SearchIncludeFragment.searchResultsCount} #{bundle['dataverse.results.count.result']}">
                                        <f:param value="#{SearchIncludeFragment.searchResultsCount}"/>
                                    </h:outputFormat>
                                </div>
                                <!-- SORT + PAGINATOR -->
                                <div class="results-sort-pagination pull-right">
                                    <!-- PAGINATOR -->
                                    <ui:fragment rendered="#{SearchIncludeFragment.totalPages != 1}">
                                        <o:importFunctions type="java.lang.Math" />
                                        <div class="pagination pull-right">
                                            <ul class="pagination">
                                                <!--should take you to page 1-->
                                                <li class="#{SearchIncludeFragment.page == '1' ? 'disabled' : ''}">
                                                    <h:outputLink>
                                                        <h:outputText value="&#171;"/>
                                                        <f:param name="id" value="#{SearchIncludeFragment.dataverseId}"/>
                                                        <f:param name="q" value="#{SearchIncludeFragment.query}"/>
                                                        <c:forEach items="#{SearchIncludeFragment.filterQueries}" var="clickedFilterQuery" varStatus="status">
                                                            <f:param name="fq#{status.index}" value='#{clickedFilterQuery}'/>
                                                        </c:forEach>
                                                        <f:param name="types" value="#{SearchIncludeFragment.selectedTypesString}"/>
                                                        <f:param name="sort" value="#{SearchIncludeFragment.sortField}"/>
                                                        <f:param name="order" value="#{SearchIncludeFragment.sortOrder}"/>
                                                        <f:param name="page" value="1"/>
                                                    </h:outputLink>
                                                </li>
                                                <li class="#{SearchIncludeFragment.page == '1' ? 'disabled' : ''}">
                                                    <h:outputLink>
                                                        <h:outputText value="&lt; #{bundle.previous}"/>
                                                        <f:param name="id" value="#{SearchIncludeFragment.dataverseId}"/>
                                                        <f:param name="q" value="#{SearchIncludeFragment.query}"/>
                                                        <c:forEach items="#{SearchIncludeFragment.filterQueries}" var="clickedFilterQuery" varStatus="status">
                                                            <f:param name="fq#{status.index}" value='#{clickedFilterQuery}'/>
                                                        </c:forEach>
                                                        <f:param name="types" value="#{SearchIncludeFragment.selectedTypesString}"/>
                                                        <f:param name="sort" value="#{SearchIncludeFragment.sortField}"/>
                                                        <f:param name="order" value="#{SearchIncludeFragment.sortOrder}"/>
                                                        <f:param name="page" value="#{Math:max(1,SearchIncludeFragment.page-1).intValue()}"/>
                                                    </h:outputLink>
                                                </li>
                                                <c:forEach begin="#{Math:max(1,SearchIncludeFragment.page-Math:max(2,SearchIncludeFragment.page-SearchIncludeFragment.totalPages+4))}"
                                                           end="#{Math:min(SearchIncludeFragment.totalPages,SearchIncludeFragment.page+Math:max(2,5-SearchIncludeFragment.page))}"
                                                           varStatus="pageStatus">
                                                    <li class="#{SearchIncludeFragment.page == pageStatus.index ? 'active' : ''}">
                                                        <h:outputLink>
                                                            <h:outputText value="#{pageStatus.index}"/>
                                                            <span class="#{SearchIncludeFragment.page == pageStatus.index ? 'sr-only' : ''}">
                                                                <h:outputText value="#{SearchIncludeFragment.page == pageStatus.index ? bundle['dataverse.results.paginator.current'] : ''}"/>
                                                            </span>
                                                            <f:param name="id" value="#{SearchIncludeFragment.dataverseId}"/>
                                                            <f:param name="q" value="#{SearchIncludeFragment.query}"/>
                                                            <c:forEach items="#{SearchIncludeFragment.filterQueries}" var="clickedFilterQuery" varStatus="status">
                                                                <f:param name="fq#{status.index}" value='#{clickedFilterQuery}'/>
                                                            </c:forEach>
                                                            <f:param name="types" value="#{SearchIncludeFragment.selectedTypesString}"/>
                                                            <f:param name="sort" value="#{SearchIncludeFragment.sortField}"/>
                                                            <f:param name="order" value="#{SearchIncludeFragment.sortOrder}"/>
                                                            <f:param name="page" value="#{pageStatus.index}"/>
                                                        </h:outputLink>
                                                    </li>
                                                </c:forEach>
                                                <li class="#{SearchIncludeFragment.page == SearchIncludeFragment.totalPages ? 'disabled' : ''}">
                                                    <h:outputLink>
                                                        <h:outputText value="#{bundle.next} &gt;"/>
                                                        <f:param name="id" value="#{SearchIncludeFragment.dataverseId}"/>
                                                        <f:param name="q" value="#{SearchIncludeFragment.query}"/>
                                                        <c:forEach items="#{SearchIncludeFragment.filterQueries}" var="clickedFilterQuery" varStatus="status">
                                                            <f:param name="fq#{status.index}" value='#{clickedFilterQuery}'/>
                                                        </c:forEach>
                                                        <f:param name="types" value="#{SearchIncludeFragment.selectedTypesString}"/>
                                                        <f:param name="sort" value="#{SearchIncludeFragment.sortField}"/>
                                                        <f:param name="order" value="#{SearchIncludeFragment.sortOrder}"/>
                                                        <f:param name="page" value="#{Math:min(SearchIncludeFragment.page+1,SearchIncludeFragment.totalPages).intValue()}"/>
                                                    </h:outputLink>
                                                </li>
                                                <li class="#{SearchIncludeFragment.page == SearchIncludeFragment.totalPages ? 'disabled' : ''}">
                                                    <h:outputLink>
                                                        <h:outputText value="&#187;"/>
                                                        <f:param name="id" value="#{SearchIncludeFragment.dataverseId}"/>
                                                        <f:param name="q" value="#{SearchIncludeFragment.query}"/>
                                                        <c:forEach items="#{SearchIncludeFragment.filterQueries}" var="clickedFilterQuery" varStatus="status">
                                                            <f:param name="fq#{status.index}" value='#{clickedFilterQuery}'/>
                                                        </c:forEach>
                                                        <f:param name="sort" value="#{SearchIncludeFragment.sortField}"/>
                                                        <f:param name="order" value="#{SearchIncludeFragment.sortOrder}"/>
                                                        <f:param name="page" value="#{SearchIncludeFragment.totalPages}"/>
                                                        <f:param name="types" value="#{SearchIncludeFragment.selectedTypesString}"/>
                                                    </h:outputLink>
                                                </li>
                                            </ul>
                                        </div>
                                    </ui:fragment>
                                    <!-- SORT BY -->
                                    <div class="btn-group pull-right">
                                        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                                            <span class="glyphicon glyphicon-sort"/> #{bundle['dataverse.results.btn.sort']} <span class="caret"/>
                                        </button>
                                        <ul class="dropdown-menu pull-right text-left" role="menu">
                                            <li>
                                                <h:outputLink>
                                                    <h:outputText value="#{bundle['dataverse.results.btn.sort.option.nameAZ']}" styleClass="#{SearchIncludeFragment.sortedByNameAsc ? 'highlightBold' : ''}"/>
                                                    <f:param name="id" value="#{SearchIncludeFragment.dataverseId}"/>
                                                    <f:param name="q" value="#{SearchIncludeFragment.query}"/>
                                                    <c:forEach items="#{SearchIncludeFragment.filterQueries}" var="clickedFilterQuery" varStatus="status">
                                                        <f:param name="fq#{status.index}" value='#{clickedFilterQuery}'/>
                                                    </c:forEach>
                                                    <f:param name="types" value="#{SearchIncludeFragment.selectedTypesString}"/>
                                                    <f:param name="page" value="1"/>
                                                    <f:param name="sort" value="#{SearchIncludeFragment.searchFieldNameSort}"/>
                                                    <f:param name="order" value="#{SearchIncludeFragment.ASCENDING}"/>
                                                </h:outputLink>
                                            </li>
                                            <li>
                                                <h:outputLink>
                                                    <h:outputText value="#{bundle['dataverse.results.btn.sort.option.nameZA']}" styleClass="#{SearchIncludeFragment.sortedByNameDesc ? 'highlightBold' : ''}"/>
                                                    <f:param name="id" value="#{SearchIncludeFragment.dataverseId}"/>
                                                    <f:param name="q" value="#{SearchIncludeFragment.query}"/>
                                                    <c:forEach items="#{SearchIncludeFragment.filterQueries}" var="clickedFilterQuery" varStatus="status">
                                                        <f:param name="fq#{status.index}" value='#{clickedFilterQuery}'/>
                                                    </c:forEach>
                                                    <f:param name="types" value="#{SearchIncludeFragment.selectedTypesString}"/>
                                                    <f:param name="page" value="1"/>
                                                    <f:param name="sort" value="#{SearchIncludeFragment.searchFieldNameSort}"/>
                                                    <f:param name="order" value="#{SearchIncludeFragment.DESCENDING}"/>
                                                </h:outputLink>
                                            </li>
                                            <li>
                                                <h:outputLink>
                                                    <h:outputText value="#{bundle['dataverse.results.btn.sort.option.newest']}" styleClass="#{SearchIncludeFragment.sortedByReleaseDateDesc? 'highlightBold' : ''}"/>
                                                    <f:param name="id" value="#{SearchIncludeFragment.dataverseId}"/>
                                                    <f:param name="q" value="#{SearchIncludeFragment.query}"/>
                                                    <c:forEach items="#{SearchIncludeFragment.filterQueries}" var="clickedFilterQuery" varStatus="status">
                                                        <f:param name="fq#{status.index}" value='#{clickedFilterQuery}'/>
                                                    </c:forEach>
                                                    <f:param name="types" value="#{SearchIncludeFragment.selectedTypesString}"/>
                                                    <f:param name="page" value="1"/>
                                                    <f:param name="sort" value="#{SearchIncludeFragment.searchFieldReleaseOrCreateDate}"/>
                                                    <f:param name="order" value="#{SearchIncludeFragment.DESCENDING}"/>
                                                </h:outputLink>
                                            </li>
                                            <li>
                                                <h:outputLink>
                                                    <h:outputText value="#{bundle['dataverse.results.btn.sort.option.oldest']}" styleClass="#{SearchIncludeFragment.sortedByReleaseDateAsc? 'highlightBold' : ''}"/>
                                                    <f:param name="id" value="#{SearchIncludeFragment.dataverseId}"/>
                                                    <f:param name="q" value="#{SearchIncludeFragment.query}"/>
                                                    <c:forEach items="#{SearchIncludeFragment.filterQueries}" var="clickedFilterQuery" varStatus="status">
                                                        <f:param name="fq#{status.index}" value='#{clickedFilterQuery}'/>
                                                    </c:forEach>
                                                    <f:param name="types" value="#{SearchIncludeFragment.selectedTypesString}"/>
                                                    <f:param name="page" value="1"/>
                                                    <f:param name="sort" value="#{SearchIncludeFragment.searchFieldReleaseOrCreateDate}"/>
                                                    <f:param name="order" value="#{SearchIncludeFragment.ASCENDING}"/>
                                                </h:outputLink>
                                            </li>
                                            <ui:fragment rendered="#{SearchIncludeFragment.mode == SearchIncludeFragment.searchModeString}">
                                                <li>
                                                    <h:outputLink>
                                                        <h:outputText value="#{bundle['dataverse.results.btn.sort.option.relevance']}" styleClass="#{SearchIncludeFragment.sortedByRelevance ? 'highlightBold' : ''}"/>
                                                        <f:param name="id" value="#{SearchIncludeFragment.dataverseId}"/>
                                                        <f:param name="q" value="#{SearchIncludeFragment.query}"/>
                                                        <c:forEach items="#{SearchIncludeFragment.filterQueries}" var="clickedFilterQuery" varStatus="status">
                                                            <f:param name="fq#{status.index}" value='#{clickedFilterQuery}'/>
                                                        </c:forEach>
                                                        <f:param name="types" value="#{SearchIncludeFragment.selectedTypesString}"/>
                                                        <f:param name="page" value="1"/>
                                                        <f:param name="sort" value="#{SearchIncludeFragment.searchFieldRelevance}"/>
                                                        <f:param name="order" value="#{SearchIncludeFragment.DESCENDING}"/>
                                                    </h:outputLink>
                                                </li>
                                            </ui:fragment>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </ui:fragment>
                        <o:importFunctions type="org.omnifaces.el.functions.Strings" />
                        <ui:param name="descriptionAbbreviationThreshold" value="200"/>
                        <!--CARDS-->
                        <p:dataTable id="resultsTable" styleClass="#{SearchIncludeFragment.searchResultsCount > 0 ? '' : 'resultsNone'}" value="#{SearchIncludeFragment.searchResultsList}" var="result">
                            <p:column styleClass="#{result.type == 'dataverses' ? 'dataverseResult' : (result.type == 'datasets' ? 'datasetResult' : '')}">
                                <!--DATAVERSE CARDS-->
                                <ui:fragment rendered="#{result.type == 'dataverses'}">
                                    <div>
                                        <h:outputLink value="#{dataversePage}?alias=#{result.dataverseAlias}" target="#{showFacets == true ? '_self' : '_blank'}">
                                            <h:outputText value="#{result.name} #{bundle.dataverse}" style="padding:4px 0;" rendered="#{result.nameHighlightSnippet == null}"/>
                                            <h:outputText value="#{result.nameHighlightSnippet} #{bundle.dataverse}" style="padding:4px 0;" rendered="#{result.nameHighlightSnippet != null}" escape="false"/>
                                            <h:outputText value=" (#{result.status})" style="padding:4px 0;" rendered="#{SearchIncludeFragment.debug == true}"/>
                                        </h:outputLink>
                                        <h:outputText value="(#{result.dataverseAffiliation})" styleClass="text-muted" style="margin-left: .5em;" rendered="#{!empty result.dataverseAffiliation and result.dataverseAffiliationHighlightSnippet == null}"/>
                                        <h:outputText value="(#{result.dataverseAffiliationHighlightSnippet})" styleClass="text-muted" style="margin-left: .5em;" rendered="#{result.dataverseAffiliationHighlightSnippet != null}" escape="false"/>
                                        <h:outputText value="#{SearchIncludeFragment.DRAFT}" styleClass="label label-warning" rendered="#{result.draftState}"/>
                                        <h:outputText value="#{SearchIncludeFragment.UNPUBLISHED}" styleClass="label label-danger" rendered="#{result.unpublishedState}"/>
                                        
                                        <span class="glyphicon glyphicon-link text-warning pull-right" jsf:rendered="#{!result.isInTree}"/>
                                        
                                        <i class="icon-dataverse text-warning pull-right" style="font-size:1.3em;line-height:1.1em;margin-right:4px;"></i>
                                        
                                    </div>
                                    <div style="width:48px; float:left; margin:4px 12px 6px 0;">
                                        <h:outputLink value="#{dataversePage}?alias=#{result.dataverseAlias}" target="#{showFacets == true ? '_self' : '_blank'}" style="display:block; clear:left; margin-bottom: .5em;">
                                            <!--img src="/resources/images/icon_dataverse.png" style="width:48px;" border="0" alt="Dataverse"/-->
                                             <p:graphicImage value="/api/access/dvCardImage/#{result.entityId}"/>
                                        </h:outputLink>
                                    </div>
                                    
                                    <h:outputText value="#{result.dateToDisplayOnCard}" styleClass="text-muted" style="margin-right:.5em;"/>

                                    <h:outputLink value="#{dataversePage}?alias=#{result.dataverseParentAlias}" target="#{showFacets == true ? '_self' : '_blank'}" rendered="#{result.parent.id != SearchIncludeFragment.dataverse.id}">
                                        <h:outputText value="#{result.parent.get('name')} #{bundle.dataverse}"/>
                                    </h:outputLink>

                                    <hr style="margin:.5em;border:0;"/>

                                    <h:outputText value="#{Strings:abbreviate(result.descriptionNoSnippet, descriptionAbbreviationThreshold)}" rendered="#{result.descriptionSnippets.size() eq 0}"/>
                                    
                                    <ui:fragment rendered="#{result.descriptionSnippets.size() gt 0}">
                                        <ui:repeat value="#{result.descriptionSnippets}" var="snippet" varStatus="varStatus">
                                            <h:outputText value="#{snippet}" escape="false"/>
                                            <h:outputText value="... " rendered="#{varStatus.last != true}"/>
                                        </ui:repeat>
                                    </ui:fragment>
                                    <ui:fragment rendered="#{false and result.matchedFields.size() > 0}">
                                        <h:outputText value="#{bundle['dataverse.results.cards.foundInMetadata']} "/>
                                        <ui:repeat value="#{result.matchedFields}" var="field" varStatus="varStatus">
                                            <h:outputText value="#{field}"/>
                                            <h:outputText value=", " rendered="#{varStatus.last != true}"/>
                                        </ui:repeat>
                                    </ui:fragment>
                                    <ui:fragment rendered="#{result.highlightsAsList.size() gt 0}">
                                        <ui:repeat value="#{result.highlightsAsList}" var="highlight">
                                            <ui:repeat value="#{highlight.snippets}" var="snippet">
                                                <br/>
                                                <ui:param value="#{highlight.solrField.nameFacetable}:intentional" name="unfriendly"/>
                                                <!--<h:outputText value="#{SearchIncludeFragment.getFriendlyNamesFromFilterQuery('name:intentional').get(0)}"/>-->
                                                <!--<h:outputText value="#{SearchIncludeFragment.getFriendlyNamesFromFilterQuery(unfriendly).get(0)}: "/>-->
                                                <h:outputText value="#{highlight.solrField.nameSearchable}: "/>
                                                <h:outputText value="#{snippet}" escape="false"/>
                                            </ui:repeat>
                                        </ui:repeat>
                                    </ui:fragment>

                                    <div style="clear:left;" jsf:rendered="#{result.datasets.size() > 0}">
                                        <a data-toggle="collapse" data-parent="#accordion" href="#childDatasetBlock#{result.entityId}" value="javascript:void(0)">
                                            [+] #{bundle['dataverse.results.cards.dataverse.preview.recentDatasets']}
                                        </a>
                                        <div class="panel-collapse collapse" id="childDatasetBlock#{result.entityId}">
                                            <p:dataTable id="childDatasetTable" value="#{result.datasets}" var="dataset" rows="3" scrollable="true">
                                                <p:column headerText="Title" style="font-size: smaller; width: 90%">
                                                    <i class="icon-dataset text-icon-inline text-muted"></i>
                                                    <a href="/dataset.xhtml?globalId=#{dataset.globalId}" target="#{showFacets == true ? '_self' : '_blank'}">
                                                        <h:outputText value="#{dataset.releasedVersion.title}" /></a>
                                                </p:column>
                                                <p:column headerText="Files" styleClass="text-right small" style="width: 10%;">
                                                    <h:outputFormat value="#{dataset.releasedVersion.fileMetadatas.size()} #{bundle['dataverse.results.cards.dataverse.preview.files']}">
                                                        <f:param value="#{dataset.releasedVersion.fileMetadatas.size()}"/>
                                                    </h:outputFormat>
                                                </p:column>
                                                <f:facet name="footer">  
                                                    <h:outputLink value="#{dataversePage}?alias=#{result.dataverseAlias}" target="#{showFacets == true ? '_self' : '_blank'}" style="font-weight:normal; font-size: smaller;">
                                                        <h:outputText value="#{bundle['dataverse.results.cards.dataverse.preview.viewAll']} &gt;"/>
                                                    </h:outputLink>
                                                </f:facet>
                                            </p:dataTable>
                                        </div>
                                    </div>
                                </ui:fragment>
                                <!--DATASET CARDS-->
                                <ui:fragment rendered="#{result.type == 'datasets'}">
                                    <div>
                                        <a href="#{result.datasetUrl}" target="#{showFacets == true ? '_self' : '_blank'}">
                                            <h:outputText value="#{result.title}" style="padding:4px 0;" rendered="#{result.titleHighlightSnippet == null}"/>
                                            <h:outputText value="#{result.titleHighlightSnippet}" style="padding:4px 0;" rendered="#{result.titleHighlightSnippet != null}" escape="false"/>
                                            <h:outputText value=" (#{result.status})" style="padding:4px 0;" rendered="#{SearchIncludeFragment.debug == true}"/></a>
                                        <h:outputText value="#{SearchIncludeFragment.DRAFT}" styleClass="label label-warning" rendered="#{result.draftState}"/>
                                        <h:outputText value="#{SearchIncludeFragment.UNPUBLISHED}" styleClass="label label-danger" rendered="#{result.unpublishedState}"/>
                                        <h:outputText value="#{SearchIncludeFragment.DEACCESSIONED}" styleClass="label label-info" rendered="#{result.deaccessionedState}"/>
                                        
                                        <span class="glyphicon glyphicon-link text-info pull-right" jsf:rendered="#{!result.isInTree}"/>
                                        
                                        <i class="icon-dataset text-info pull-right" style="font-size:1.3em;line-height:1.1em;margin-right:4px;"></i>
                                        
                                    </div>
                                    <!--<span class="label label-default">Default</span>-->
                                    <div style="width:48px; float:left; margin:4px 12px 6px 0;">
                                        <!-- img src="/resources/images/icon_dataset.png" style="width:48px;" border="0" alt="Dataset"/ -->
                                        <a href="#{result.datasetUrl}" target="#{showFacets == true ? '_self' : '_blank'}" style="display:block; clear:left; margin-bottom: .5em;">
                                            <p:graphicImage value="/api/access/dsPreview/#{result.datasetVersionId}"/>
                                        </a>
                                    </div>

                                    <h:outputText styleClass="text-muted" value="#{result.dateToDisplayOnCard}"/>

                                    <h:outputText styleClass="text-muted" value=" - " rendered="#{result.parent.id != SearchIncludeFragment.dataverse.id}"/>
                                    <h:outputLink value="#{dataversePage}?alias=#{result.dataverseAlias}" target="#{showFacets == true ? '_self' : '_blank'}" rendered="#{result.parent.id != SearchIncludeFragment.dataverse.id}">
                                        <h:outputText value="#{result.parent.get('name')} #{bundle.dataverse}"/>
                                    </h:outputLink>

                                    <h:outputText value="#{result.citation}" styleClass="resultDatasetCitationBlock bg-info"/>
                                    <h:outputText value="#{result.citation}" escape="false"/>
                                    <h:outputText value="#{Strings:abbreviate(result.descriptionNoSnippet, descriptionAbbreviationThreshold)}" rendered="#{result.descriptionSnippets.size() eq 0}"/>
                                    <ui:fragment rendered="#{result.descriptionSnippets.size() gt 0}">
                                        <ui:repeat value="#{result.descriptionSnippets}" var="snippet" varStatus="varStatus">
                                            <h:outputText value="... #{snippet} ..." escape="false"/>
                                            <!-- <h:outputText value="... " rendered="#{varStatus.last != true}"/> -->
                                        </ui:repeat>
                                    </ui:fragment>

                                    <ui:fragment rendered="#{false and result.matchedFields.size() > 0}">
                                        <h:outputText value="#{bundle['dataverse.results.cards.foundInMetadata']} "/>
                                        <ui:repeat value="#{result.matchedFields}" var="field" varStatus="varStatus">
                                            <h:outputText value="#{field}"/>
                                            <h:outputText value=", " rendered="#{varStatus.last != true}"/>
                                        </ui:repeat>
                                    </ui:fragment>
                                    <ui:fragment rendered="#{result.highlightsAsList.size() > 0}">
                                        <ui:repeat value="#{result.highlightsAsList}" var="highlight">
                                            <ui:repeat value="#{highlight.snippets}" var="snippet">
                                                <br/>
                                                <!--<ui:param value="#{highlight.solrField.nameFacetable}:intentional" name="unfriendly"/>-->
                                                <!--<h:outputText value="#{SearchIncludeFragment.getFriendlyNamesFromFilterQuery('name:intentional').get(0)}"/>-->
                                                <!--<h:outputText value="#{SearchIncludeFragment.getFriendlyNamesFromFilterQuery(unfriendly).get(0)}: "/>-->
                                                <h:outputText value="#{highlight.displayName}: "/>
                                                <h:outputText value="#{snippet}" escape="false"/>
                                            </ui:repeat>
                                        </ui:repeat>
                                    </ui:fragment>
                                </ui:fragment>
                                <!--FILE CARDS-->
                                <ui:fragment rendered="#{result.type == 'files'}">
                                    <div>
                                        <a href="#{result.fileUrl}" target="#{showFacets == true ? '_self' : '_blank'}">
                                            <h:outputText value="#{result.name}" style="padding:4px 0;" rendered="#{result.nameHighlightSnippet == null}"/>
                                            <h:outputText value="#{result.nameHighlightSnippet}" style="padding:4px 0;" rendered="#{result.nameHighlightSnippet != null}" escape="false"/>
                                            <h:outputText value=" (#{result.status})" style="padding:4px 0;" rendered="#{SearchIncludeFragment.debug == true}"/></a>
                                        <h:outputText value="#{SearchIncludeFragment.DRAFT}" styleClass="label label-warning" rendered="#{result.draftState}"/>
                                        <h:outputText value="#{SearchIncludeFragment.UNPUBLISHED}" styleClass="label label-danger" rendered="#{result.unpublishedState}"/>
                                        
                                        <span class="glyphicon glyphicon-link text-muted pull-right" jsf:rendered="#{!result.parent.get('isInTree')}"/>
                                        
                                        <i class="icon-file text-muted pull-right" style="font-size:1.3em;line-height:1.1em;margin-right:4px;"/>
                                        
                                    </div>
                                    <ui:remove>
                                    <div>
                                        <h:outputText value="(thumbnail available)" rendered="#{dataFileServiceBean.isPreviewAvailable(result.entityId)}"/>
                                        <h:outputText value="(thumbnail not available)" rendered="#{!dataFileServiceBean.isPreviewAvailable(result.entityId)}"/>
                                    </div>
                                    <div>
                                        <h:outputText value="#{dataFileServiceBean.getFileClassById(result.entityId)}"/>
                                    </div>
                                    </ui:remove>
                                    
                                    <div style="width:48px; float:left; margin:4px 12px 6px 0">
                                        <!-- img src="/resources/images/icon_file.png" style="width:48px;" border="0" alt="Data File"/ -->
                                        <ui:fragment rendered="#{dataFileServiceBean.isPreviewAvailable(result.entityId)}">
                                            <a href="#{result.fileUrl}" target="#{showFacets == true ? '_self' : '_blank'}" style="clear:left; margin-bottom: .5em;">
                                                <p:graphicImage value="/api/access/preview/#{result.entityId}" />
                                            </a>
                                        </ui:fragment>
                                        
                                        <i class="icon-#{dataFileServiceBean.getFileClassById(result.entityId)} text-muted h1"
                                           jsf:rendered="#{!dataFileServiceBean.isPreviewAvailable(result.entityId)}"/>
                                    </div>

                                    <h:outputText styleClass="text-muted" value="#{result.dateToDisplayOnCard} - "/>

                                    <a href="#{result.fileUrl}" target="#{showFacets == true ? '_self' : '_blank'}">
                                        <h:outputText value="#{result.parent.get('name')}"/></a>
                                    
                                    <ui:fragment>
                                        <br/>
                                        <h:outputText value="#{bundle['dataverse.results.cards.files.tabularData']}" styleClass="text-muted" rendered="#{!empty SearchIncludeFragment.tabularDataDisplayInfo(result.entityId)}"/>
                                        <h:outputText value="#{result.filetype}" styleClass="text-muted" rendered="#{empty SearchIncludeFragment.tabularDataDisplayInfo(result.entityId) and result.fileTypeHighlightSnippet == null}"/>
                                        <h:outputText value="#{result.fileTypeHighlightSnippet}" styleClass="text-muted" rendered="#{empty SearchIncludeFragment.tabularDataDisplayInfo(result.entityId) and result.fileTypeHighlightSnippet != null}" escape="false"/>
                                        
                                        <h:outputText styleClass="text-muted" value=" - #{SearchIncludeFragment.dataFileSizeDisplay(result.entityId)} - "/>
                                        
                                        <h:outputText styleClass="text-muted" value="#{SearchIncludeFragment.dataFileMD5Display(result.entityId)}" rendered="#{!SearchIncludeFragment.isTabular(result.entityId)}"/>
                                        
                                        <!-- if this is a tabular data file, extra information, such as the numbers of variables and observations and the unf, is displayed: -->
                                        <ui:fragment rendered="#{!empty SearchIncludeFragment.tabularDataDisplayInfo(result.entityId)}">
                                            <h:outputText styleClass="text-muted" value="#{SearchIncludeFragment.tabularDataDisplayInfo(result.entityId)}"/>
                                        </ui:fragment>
                                        
                                        <br/>
                                    </ui:fragment>
                                    
                                    <h:outputText value="#{Strings:abbreviate(result.descriptionNoSnippet, descriptionAbbreviationThreshold)}" rendered="#{result.descriptionSnippets.size() eq 0}"/>
                                    <ui:fragment rendered="#{result.descriptionSnippets.size() gt 0}">
                                        <ui:repeat value="#{result.descriptionSnippets}" var="snippet" varStatus="varStatus">
                                            <h:outputText value="#{snippet}" escape="false"/>
                                            <h:outputText value="... " rendered="#{varStatus.last != true}"/>
                                        </ui:repeat>
                                    </ui:fragment>
                                    
                                    <div jsf:rendered="#{result.highlightsAsList.size() > 0}">
                                        <ui:repeat value="#{result.highlightsAsList}" var="highlight">
                                            <ui:repeat value="#{highlight.snippets}" var="snippet">
                                                <h:outputText value="#{highlight.displayName}: "/>
                                                <h:outputText value="#{snippet}" escape="false"/>
                                                <br/>
                                            </ui:repeat>
                                        </ui:repeat>
                                    </div>
                                </ui:fragment>
                            </p:column>
                        </p:dataTable>
                        <!-- BOTTOM PAGINATOR -->
                        <ui:fragment rendered="#{SearchIncludeFragment.totalPages != 1}">
                            <div class="results-sort-pagination results-bottom pull-right">
                                <!-- PAGINATOR -->
                                <o:importFunctions type="java.lang.Math" />
                                <div class="pagination pull-right" >
                                    <ul class="pagination">
                                        <!--should take you to page 1-->
                                        <li class="#{SearchIncludeFragment.page == '1' ? 'disabled' : ''}">
                                            <h:outputLink>
                                                <h:outputText value="&#171;"/>
                                                <f:param name="id" value="#{SearchIncludeFragment.dataverseId}"/>
                                                <f:param name="q" value="#{SearchIncludeFragment.query}"/>
                                                <c:forEach items="#{SearchIncludeFragment.filterQueries}" var="clickedFilterQuery" varStatus="status">
                                                    <f:param name="fq#{status.index}" value='#{clickedFilterQuery}'/>
                                                </c:forEach>
                                                <f:param name="types" value="#{SearchIncludeFragment.selectedTypesString}"/>
                                                <f:param name="sort" value="#{SearchIncludeFragment.sortField}"/>
                                                <f:param name="order" value="#{SearchIncludeFragment.sortOrder}"/>
                                                <f:param name="page" value="1"/>
                                            </h:outputLink>
                                        </li>
                                        <li class="#{SearchIncludeFragment.page == '1' ? 'disabled' : ''}">
                                            <h:outputLink>
                                                <h:outputText value="&lt; #{bundle.previous}"/>
                                                <f:param name="id" value="#{SearchIncludeFragment.dataverseId}"/>
                                                <f:param name="q" value="#{SearchIncludeFragment.query}"/>
                                                <c:forEach items="#{SearchIncludeFragment.filterQueries}" var="clickedFilterQuery" varStatus="status">
                                                    <f:param name="fq#{status.index}" value='#{clickedFilterQuery}'/>
                                                </c:forEach>
                                                <f:param name="types" value="#{SearchIncludeFragment.selectedTypesString}"/>
                                                <f:param name="sort" value="#{SearchIncludeFragment.sortField}"/>
                                                <f:param name="order" value="#{SearchIncludeFragment.sortOrder}"/>
                                                <f:param name="page" value="#{Math:max(1,SearchIncludeFragment.page-1).intValue()}"/>
                                            </h:outputLink>
                                        </li>
                                        <c:forEach begin="#{Math:max(1,SearchIncludeFragment.page-Math:max(2,SearchIncludeFragment.page-SearchIncludeFragment.totalPages+4))}"
                                                   end="#{Math:min(SearchIncludeFragment.totalPages,SearchIncludeFragment.page+Math:max(2,5-SearchIncludeFragment.page))}"
                                                   varStatus="pageStatus">
                                            <li class="#{SearchIncludeFragment.page == pageStatus.index ? 'active' : ''}">
                                                <h:outputLink>
                                                    <h:outputText value="#{pageStatus.index}"/>
                                                    <span class="#{SearchIncludeFragment.page == pageStatus.index ? 'sr-only' : ''}">
                                                        <h:outputText value="#{SearchIncludeFragment.page == pageStatus.index ? bundle['dataverse.results.paginator.current'] : ''}"/>
                                                    </span>
                                                    <f:param name="id" value="#{SearchIncludeFragment.dataverseId}"/>
                                                    <f:param name="q" value="#{SearchIncludeFragment.query}"/>
                                                    <c:forEach items="#{SearchIncludeFragment.filterQueries}" var="clickedFilterQuery" varStatus="status">
                                                        <f:param name="fq#{status.index}" value='#{clickedFilterQuery}'/>
                                                    </c:forEach>
                                                    <f:param name="types" value="#{SearchIncludeFragment.selectedTypesString}"/>
                                                    <f:param name="sort" value="#{SearchIncludeFragment.sortField}"/>
                                                    <f:param name="order" value="#{SearchIncludeFragment.sortOrder}"/>
                                                    <f:param name="page" value="#{pageStatus.index}"/>
                                                </h:outputLink>
                                            </li>
                                        </c:forEach>
                                        <li class="#{SearchIncludeFragment.page == SearchIncludeFragment.totalPages ? 'disabled' : ''}">
                                            <h:outputLink>
                                                <h:outputText value="#{bundle.next} &gt;"/>
                                                <f:param name="id" value="#{SearchIncludeFragment.dataverseId}"/>
                                                <f:param name="q" value="#{SearchIncludeFragment.query}"/>
                                                <c:forEach items="#{SearchIncludeFragment.filterQueries}" var="clickedFilterQuery" varStatus="status">
                                                    <f:param name="fq#{status.index}" value='#{clickedFilterQuery}'/>
                                                </c:forEach>
                                                <f:param name="types" value="#{SearchIncludeFragment.selectedTypesString}"/>
                                                <f:param name="sort" value="#{SearchIncludeFragment.sortField}"/>
                                                <f:param name="order" value="#{SearchIncludeFragment.sortOrder}"/>
                                                <f:param name="page" value="#{Math:min(SearchIncludeFragment.page+1,SearchIncludeFragment.totalPages).intValue()}"/>
                                            </h:outputLink>
                                        </li>
                                        <li class="#{SearchIncludeFragment.page == SearchIncludeFragment.totalPages ? 'disabled' : ''}">
                                            <h:outputLink>
                                                <h:outputText value="&#187;"/>
                                                <f:param name="id" value="#{SearchIncludeFragment.dataverseId}"/>
                                                <f:param name="q" value="#{SearchIncludeFragment.query}"/>
                                                <c:forEach items="#{SearchIncludeFragment.filterQueries}" var="clickedFilterQuery" varStatus="status">
                                                    <f:param name="fq#{status.index}" value='#{clickedFilterQuery}'/>
                                                </c:forEach>
                                                <f:param name="sort" value="#{SearchIncludeFragment.sortField}"/>
                                                <f:param name="order" value="#{SearchIncludeFragment.sortOrder}"/>
                                                <f:param name="page" value="#{SearchIncludeFragment.totalPages}"/>
                                                <f:param name="types" value="#{SearchIncludeFragment.selectedTypesString}"/>
                                            </h:outputLink>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </ui:fragment>
                    </ui:fragment>
                </div>
            </ui:fragment>
            <ui:fragment rendered="#{SearchIncludeFragment.solrIsDown}">
                <p>
                    <h:outputText value="#{bundle['dataverse.results.solrIsDown']}" style="font-weight:bolder; font-size: xx-large"/>
                </p>
                <p>
                    <h:outputText value="#{SearchIncludeFragment.searchException.message}" style="font-weight:bolder; font-size: xx-large"/>
                </p>
                <p>
                    <h:outputText value="#{SearchIncludeFragment.searchException.cause.message}" style="font-weight:bolder; font-size: xx-large"/>
                </p>
            </ui:fragment>
        </div>
    </div>
</div>
