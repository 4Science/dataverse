<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  
      xmlns:h="http://java.sun.com/jsf/html"  
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:ui="http://java.sun.com/jsf/facelets"      
      xmlns:c="http://java.sun.com/jsp/jstl/core"
      xmlns:p="http://primefaces.org/ui">  

    <h:head>
    </h:head>

    <h:body> 
        <ui:composition template="/dataverse_template.xhtml">
            <ui:param name="pageTitle" value="Search"/>
            <ui:param name="dataverse" value="#{dataverseServiceBean.findRootDataverse()}"/> 
            <ui:define name="body">         
                <f:metadata>
                    <f:viewParam name="q" value="#{SearchPage.query}"/>
                    <f:viewParam name="start" value="#{SearchPage.paginationStart}"/>
                    <f:viewParam name="fq0" value="#{SearchPage.fq0}"/>
                    <f:viewParam name="fq1" value="#{SearchPage.fq1}"/>
                    <f:viewParam name="fq2" value="#{SearchPage.fq2}"/>
                    <f:viewParam name="fq3" value="#{SearchPage.fq3}"/>
                    <f:viewParam name="fq4" value="#{SearchPage.fq4}"/>
                    <f:viewParam name="fq5" value="#{SearchPage.fq5}"/>
                    <f:viewParam name="fq6" value="#{SearchPage.fq6}"/>
                    <f:viewParam name="fq7" value="#{SearchPage.fq7}"/>
                    <f:viewParam name="fq8" value="#{SearchPage.fq8}"/>
                    <f:viewParam name="fq9" value="#{SearchPage.fq9}"/>
                    <f:viewParam name="fromDataverseId" value="#{SearchPage.fromDataverseId}"/>
                    <f:viewAction action="#{SearchPage.search()}" />
                </f:metadata>  

                <h:form id="searchPageForm">
                    <!-- Breadcrumbs Panel -->
                    <p:panel styleClass="panelLayoutBlock breadcrumbNavBlock">
                        <ui:repeat value="#{SearchPage.fromDataverse.owners}" var="owner">
                            <h:outputLink value="/dataverse.xhtml?id=#{owner.id}">
                                <h:outputText value="#{owner.name} Dataverse"/>
                            </h:outputLink>
                            <h:outputText value=" > "/>
                        </ui:repeat>
                        <h:outputText value="#{DataversePage.dataverse.name} Dataverse" style="font-weight:bold;"/>
                    </p:panel>

                    <p:panel styleClass="panelLayoutBlock">
                        <p:focus/>
                        <p:autoComplete id="autoCompleteSearch" size="40" value="#{SearchPage.query}" completeMethod="#{autoCompleteBean.complete}" style="margin-right:1em;"/>
                        <!--<p:watermark for="search" value="#{SearchPage.query}"/>-->
                        <!--https://blogs.oracle.com/enterprisetechtips/entry/post_redirect_get_and_jsf-->
                        <p:commandButton id="searchbutton" value="Find" action="search.xhtml?faces-redirect=true&amp;includeViewParams=true" update="@all"/>
                    </p:panel>

                    <style type="text/css">
                        table.ui-panelgrid.facetsMoreLess {width:100%;}
                        table.ui-panelgrid.facetsMoreLess tr.ui-widget-content {border:0;}
                        table.ui-panelgrid.facetsMoreLess td {width:50%; border:0;}
                        table.ui-panelgrid.facetsMoreLess td:last-child {text-align:right;}
                        div[id$="resultsTable"] .ui-datatable-tablewrapper table > thead {display:none;}
                        
                        div[id$="resultsTable"] > .ui-datatable-tablewrapper > table {border-collapse:separate; border-spacing:0 1em;}
                    </style>
                    
                    <!-- Content Panel -->
                    <ui:fragment rendered="#{SearchPage.fromDataverseId != null}">
                    <h:outputText value="DEBUG: Cards for the #{SearchPage.fromDataverse.name} Dataverse and its children. "/>
                    <h:outputLink value="/dataverse.xhtml">
                        <f:param name="id" value="#{SearchPage.fromDataverseId}"/>
                        <h:outputText value="Click here to return to the dataverse page for the #{SearchPage.fromDataverse.name} Dataverse." style="color: blue"/>
                    </h:outputLink>
                    </ui:fragment>
                    <p:panel id="content" styleClass="panelLayoutBlock">
                        <h:outputText style="color: red" value="Did you mean #{SearchPage.spelling_alternatives}?" rendered="#{SearchPage.spelling_alternatives.size() != 0}"/>

                        <div style="overflow:hidden;">
                            <div style="width:20%;float:left;">
                                <p:dataList id="facetCategoryList" value="#{SearchPage.facetCategoryList}" var="facetCategory">
                                    <!--<h:outputText value="#{facetCategory.name}" styleClass="facetCategoryName" rendered="#{facetCategory.name != 'type_s'}"/>-->
                                    <h:outputText value="#{facetCategory.name}" styleClass="facetCategoryName" rendered="#{facetCategory.name != 'type_s'}"/>
                                    <!--<p:dataList id="facetLabelList" value="#{facetCategory.facetLabel}" var="facetLabel" rendered="#{facetCategory.name != 'type_s'}">-->
                                    <p:dataList id="facetLabelList" value="#{facetCategory.facetLabel}" var="facetLabel"  rows="#{SearchPage.getNumberOfFacets(facetCategory.name,5)}">
                                        <h:outputText style="padding:4px 0px 4px 30px; background: url(/resources/images/icon_dataverse.png) no-repeat 4px 50% / 18px;" rendered='#{facetLabel.filterQuery =="type_s:\"dataverses\""}'/>
                                        <h:outputText style="padding:4px 0px 4px 30px; background: url(/resources/images/icon_dataset.png) no-repeat 4px 50% / 18px;" rendered='#{facetLabel.filterQuery =="type_s:\"datasets\""}'/>
                                        <h:outputText style="padding:4px 0px 4px 30px; background: url(/resources/images/icon_file.png) no-repeat 4px 50% / 18px;" rendered='#{facetLabel.filterQuery =="type_s:\"files\""}'/>
                                        <h:outputLink disabled="#{SearchPage.filterQueries.contains(facetLabel.filterQuery)}">
                                            <f:param name="q" value="#{SearchPage.query}"/>
                                            <c:forEach items="#{SearchPage.filterQueries}" var="clickedFilterQuery" varStatus="status">
                                                <f:param name="fq#{status.index}" value='#{clickedFilterQuery}'/>
                                            </c:forEach>
                                            <f:param name="fq#{SearchPage.filterQueries.size()}" value="#{facetLabel.filterQuery}"/>
                                            <h:outputText value="#{facetCategory.name == 'type_s' ? facetLabel.capitalizedName : facetLabel.name} Dataverse" style="color: #{SearchPage.filterQueries.contains(facetLabel.filterQuery) ? '#C55B28' : 'black'}"/>
                                            <h:outputText value="#{facetCategory.name == 'type_s' ? facetLabel.capitalizedName : facetLabel.name}" style="color: #{SearchPage.filterQueries.contains(facetLabel.filterQuery) ? '#C55B28' : 'black'}"/>
                                        </h:outputLink>
                                        <h:outputText value=" (#{facetLabel.count})" style="color:#AAA; margin-right:.5em;"/>
                                        <h:outputLink rendered="#{SearchPage.filterQueries.contains(facetLabel.filterQuery)}" style="color:#C55B28">
                                            <h:outputText value="X" style="color: #{SearchPage.filterQueries.contains(facetLabel.filterQuery) ?  '#C55B28' : 'black'}"/>
                                            <f:param name="q" value="#{SearchPage.query}"/>
                                            <c:forEach items="#{SearchPage.filterQueries}" var="clickedFilterQuery" varStatus="status">
                                                <f:param name="fq#{status.index}" value='#{clickedFilterQuery}' disable="#{clickedFilterQuery == facetLabel.filterQuery}"/>
                                            </c:forEach>
                                        </h:outputLink>
                                    </p:dataList>
                                    <p:panelGrid styleClass="facetsMoreLess" columns="2" rendered="#{(SearchPage.getNumberOfFacets(facetCategory.name,5) lt facetCategory.facetLabel.size()) or (SearchPage.getNumberOfFacets(facetCategory.name,5) gt 5)}">
                                        <ui:fragment>
                                            <p:commandLink actionListener="#{SearchPage.incrementFacets(facetCategory.name,-5)}" update="facetCategoryList" rendered="#{SearchPage.getNumberOfFacets(facetCategory.name,5) gt 5}">Less...</p:commandLink>
                                        </ui:fragment>
                                        <ui:fragment>
                                            <p:commandLink actionListener="#{SearchPage.incrementFacets(facetCategory.name,5)}" update="facetCategoryList" rendered="#{SearchPage.getNumberOfFacets(facetCategory.name,5) lt facetCategory.facetLabel.size()}">More...</p:commandLink>
                                        </ui:fragment>
                                    </p:panelGrid>
                                </p:dataList>
                            </div>
                            <div style="width:77%;float:left;padding-left:20px;">
                                
                                
                                <h:outputText value="#{SearchPage.searchResultsCount} results for " style="font-weight: bold"/>
                                <h:outputLink value="/search.xhtml" rendered="#{SearchPage.query != '*'}" style="color: #C55B28">
                                    <f:param name="q" value="*"/>
                                    <c:forEach items="#{SearchPage.filterQueries}" var="clickedFilterQuery" varStatus="status">
                                        <f:param name="fq#{status.index}" value='#{clickedFilterQuery}' disable="#{clickedFilterQuery == facetLabel.filterQuery}"/>
                                    </c:forEach>
                                    <h:outputText value="&#34;#{SearchPage.query}&#34; X" style="color: #C55B28"/>
                                </h:outputLink>
                                <h:outputText value="&#34;*&#34;" rendered="#{SearchPage.query == '*'}" style="color: #C55B28"/>
                                
                                <h:outputText value=" refined with " rendered="#{SearchPage.filterQueries.size() > 0}" style="font-weight: bold"/>
                                <h:outputLink value="/search.xhtml" rendered="#{SearchPage.filterQueries.size() > 0}" style="color: #C55B28">
                                    <f:param name="q" value="#{SearchPage.query}"/>
                                    <h:outputText value="#{SearchPage.filterQueries} X" style="color: #C55B28"/>
                                </h:outputLink>
                                
                                <div style="float: right">
                                    <h:outputText value="Page " rendered="#{SearchPage.searchResultsCount > 11}"/>
                                    <h:outputText value="#{(SearchPage.paginationStart + 10) / 10}" rendered="#{SearchPage.searchResultsCount > 11}"><f:convertNumber pattern="#0" /></h:outputText>
                                    <!--<h:outputLink value="/search.xhtml" disabled="#{SearchPage.paginationStart == 0}">-->
                                    <h:outputLink value="/search.xhtml" rendered="#{SearchPage.paginationStart != 0 and SearchPage.searchResultsCount - 10 > SearchPage.paginationStart - 10}">
                                        <f:param name="q" value="#{SearchPage.query}"/>
                                        <f:param name="start" value="#{SearchPage.paginationStart - 10}"/>
                                        <c:forEach items="#{SearchPage.filterQueries}" var="clickedFilterQuery" varStatus="status">
                                            <f:param name="fq#{status.index}" value='#{clickedFilterQuery}' disable="#{clickedFilterQuery == facetLabel.filterQuery}"/>
                                        </c:forEach>
                                        <h:outputText value="Previous"/>
                                    </h:outputLink>
                                    <!--<h:outputLink value="/search.xhtml" disabled="#{SearchPage.paginationStart + 10 >= SearchPage.searchResultsCount}">-->
                                    <h:outputLink value="/search.xhtml" rendered="#{SearchPage.searchResultsCount - 10 > SearchPage.paginationStart}">
                                        <f:param name="q" value="#{SearchPage.query}"/>
                                        <f:param name="start" value="#{SearchPage.paginationStart + 10}"/>
                                        <c:forEach items="#{SearchPage.filterQueries}" var="clickedFilterQuery" varStatus="status">
                                            <f:param name="fq#{status.index}" value='#{clickedFilterQuery}' disable="#{clickedFilterQuery == facetLabel.filterQuery}"/>
                                        </c:forEach>
                                        <h:outputText value="Next"/>
                                    </h:outputLink>
                                </div>
                                <p:dataTable id="resultsTable" value="#{SearchPage.searchResultsList}" var="result">
                                    <p:column>
                                        <ui:fragment rendered="#{result.type == 'dataverses'}">
                                            <h:outputLink value="/dataverse.xhtml?id=#{result.entityId}" style="display:block; font-weight:bold; clear:left; margin-bottom: .5em;">
                                                <h:outputText value="#{result.name} Dataverse" style="padding:4px 0;"/>
                                            </h:outputLink>
                                            <div style="width:48px; float:left; margin:4px 12px 6px 0;">
                                                <img src="/resources/images/icon_dataverse.png" style="width:48px;" border="0" alt="Dataverse"/>
                                            </div>
                                            
                                            <h:outputText value="#{result.dataverseAffiliation}" rendered="#{result.dataverseAffiliation != null}" style="display:block; margin-bottom: .5em; color:#999999;"/>
                                            
                                            <p:outputPanel style="margin-bottom: .5em;" rendered="#{(result.highlightSnippets == null) or result.highlightSnippets.size() != null}">
                                                <h:outputText value="#{result.highlightSnippets}" rendered="#{result.highlightSnippets.size() != null}" escape="false"/>
                                                <h:outputText value="#{result.descriptionNoSnippet}" rendered="#{result.highlightSnippets == null}"/>
                                            </p:outputPanel>
                                            
                                            <div style="clear:left;">
                                                
                                                <h:outputLink id="effectLnkShow" value="javascript:void(0)">  
                                                    <h:outputText id="effectLnkShowTxt" value="Show the child items..." />  
                                                    <p:effect type="slideToggle" event="click" for="childDatasetTable">  
                                                        <f:param name="mode" value="'show'" />
                                                    </p:effect>
                                                    <p:effect type="slideToggle" event="click" for="childDatasetTableControls">  
                                                        <f:param name="mode" value="'show'" />
                                                    </p:effect>
                                                    <p:effect type="hide" event="click" for="effectLnkShow">  
                                                        <f:param name="mode" value="'hide'" />
                                                    </p:effect>
                                                    <p:effect type="show" event="click" for="effectLnkHide">  
                                                        <f:param name="mode" value="'show'" />
                                                    </p:effect>
                                                </h:outputLink>
                                                
                                                <h:outputLink id="effectLnkHide" value="javascript:void(0)" style="display:none;">  
                                                    <h:outputText id="effectLnkHideTxt" value="Hide the child items..." />
                                                    <p:effect type="slideToggle" event="click" for="childDatasetTable">  
                                                        <f:param name="mode" value="'hide'" />
                                                    </p:effect>
                                                    <p:effect type="slideToggle" event="click" for="childDatasetTableControls">  
                                                        <f:param name="mode" value="'hide'" />
                                                    </p:effect>
                                                    <p:effect type="hide" event="click" for="effectLnkHide">  
                                                        <f:param name="mode" value="'hide'" />
                                                    </p:effect>
                                                    <p:effect type="show" event="click" for="effectLnkShow">  
                                                        <f:param name="mode" value="'show'" />
                                                    </p:effect>
                                                </h:outputLink>
                                                
                                                <p:dataTable style="display:none;" id="childDatasetTable" value="#{result.datasets}" var="dataset" rows="#{SearchPage.getNumberOfChildDatasets(result.datasets,5)}" scrollable="true" rendered="#{result.datasets.size() > 0}">  
                                                    <p:column headerText="Title" style="font-size: smaller; width: 90%">
                                                        <img src="/resources/images/icon_dataset.png" style="width:18px;margin:0 4px 0 0;vertical-align:bottom;" border="0" alt="Dataset" />
                                                        <h:outputLink value="/dataset.xhtml?id=#{dataset.id}">
                                                            <h:outputText value="#{dataset.getLatestVersion().getMetadata().getTitle()}" />
                                                        </h:outputLink>
                                                    </p:column>  
                                                    <p:column headerText="Files" style="font-size: smaller; width: 10%; text-align: right">  
                                                        <h:outputText value="#{dataset.getFiles().size()} #{dataset.getFiles().size() == 0 or dataset.getFiles().size() > 1 ? 'Files' : 'File'}" />
                                                    </p:column>  
                                                    <!--<p:column headerText="Citation Date" style="font-size: smaller; width:20%; text-align: right">-->  
                                                    <!--<h:outputText value="FIXME" />-->
                                                    <!--</p:column>-->
                                                </p:dataTable>
                                                
                                                
                                                <p:panelGrid styleClass="childResultsMoreLess" id="childDatasetTableControls" columns="2" style="display:none;">
                                                    <ui:fragment>
                                                        <p:commandLink actionListener="#{SearchPage.incrementChildDatasets(result.datasets.name,-5)}" update="childDatasetTable">Less...</p:commandLink>
                                                    </ui:fragment>
                                                    <ui:fragment>
                                                        <p:commandLink actionListener="#{SearchPage.incrementChildDatasets(result.datasets.name,5)}" update="childDatasetTable">More...</p:commandLink>
                                                    </ui:fragment>
                                                </p:panelGrid>
                                                
                                                
                                                <!--<h:outputLink value="/dataverse.xhtml?id=#{result.entityId}" rendered="#{result.datasets.size() > 3}">
                                                    <h:outputText value="&#160;&#160;&#160;> View #{result.datasets.size() - 3} more"/>
                                                </h:outputLink>-->
                                            </div>
                                            <!--<div style="clear: left">
                                                <h:outputText value="### downloads + analysis"/>
                                            </div>-->
                                        </ui:fragment>
                                        <ui:fragment rendered="#{result.type == 'datasets'}">
                                            <h:outputLink value="/dataset.xhtml?id=#{result.entityId}" style="display:block; font-weight:bold; clear:left; margin-bottom: .5em;">
                                                <h:outputText value="#{result.title}" style="padding:4px 0;"/>
                                            </h:outputLink>
                                            <div style="width:48px; float:left; margin:4px 12px 6px 0;">
                                                <img src="/resources/images/icon_dataset.png" style="width:48px;" border="0" alt="Dataset"/>
                                            </div>
                                            
                                            <h:outputText value="LastName, FirstName" style="display:block; margin-bottom: .5em; color:#999999;"/>
                                            
                                            <h:outputText value="#{result.citation}" escape="false" style="display:block;margin:4px 0 .5em 60px;background:#E6F1F6;padding:4px;"/>
                                            
                                            <h:outputLink value="/dataverse.xhtml?id=#{result.parent.get('id')}" style="display:block;">
                                                    <h:outputText value="Original Dataverse: #{result.parent.get('name')} Dataverse"/>
                                            </h:outputLink>
                                            
                                            <ui:fragment rendered="#{(result.highlightSnippets == null) or result.highlightSnippets.size() != null}">
                                                <h:outputText value="#{result.highlightSnippets}" rendered="#{result.highlightSnippets.size() != null}" escape="false"/>
                                                <h:outputText value="#{result.descriptionNoSnippet}" rendered="#{result.highlightSnippets == null}"/>
                                            </ui:fragment>
                                            
                                            <!--<div style="clear: left">
                                                <h:outputText value="### downloads + analysis"/>
                                            </div>-->
                                        </ui:fragment>
                                        <ui:fragment rendered="#{result.type == 'files'}">
                                            <!--FIXME: have a landing page for each file?-->
                                            <h:outputLink value="/dataset.xhtml?id=#{result.parent.get('id')}" style="display:block; font-weight:bold; clear:left; margin-bottom: .5em;">
                                                <h:outputText value="#{result.name}" style="padding:4px 0;"/>
                                            </h:outputLink>
                                            <div style="width:48px; float:left; margin:4px 12px 6px 0">
                                                <img src="/resources/images/icon_file.png" style="width:48px;" border="0" alt="Data File"/>
                                            </div>
                                            
                                            <h:outputText value="#{result.filetype}" style="display:block; margin-bottom: .5em; color:#999999;"/>
                                            
                                            <h:outputLink value="/dataset.xhtml?id=#{result.parent.get('id')}" style="display:block;">
                                                <h:outputText value="Dataset: #{result.parent.get('name')}"/>
                                            </h:outputLink>
                                            
                                            <!--<h:outputText value="Description of file here"/><br/>-->
                                            <!--<div style="clear:left;"> this needs to be a datatable-->
                                            <!--<h:outputText value="Variable Label Title | Variable Value Title"/><br/>-->
                                            <!--<h:outputText value="Label | Value"/><br/>-->
                                            <!--<h:outputText value="Label | Value"/><br/>--> 
                                            <!--<h:outputText value="&#160;&#160;&#160;> View More"/>-->
                                            <!--</div>-->
                                            <!--<h:outputText value="* ## other data files from this dataset also match this keyword"/><br/>-->
                                            <!--<div style="clear: left">
                                                <h:outputText value="### downloads + analysis"/>
                                            </div>-->
                                        </ui:fragment>
                                    </p:column>
                                </p:dataTable>
                                <div style="float: right">
                                    <h:outputText value="Page " rendered="#{SearchPage.searchResultsCount > 11}"/>
                                    <h:outputText value="#{(SearchPage.paginationStart + 10) / 10}" rendered="#{SearchPage.searchResultsCount > 11}"><f:convertNumber pattern="#0" /></h:outputText>
                                    <!--<h:outputLink value="/search.xhtml" disabled="#{SearchPage.paginationStart == 0}">-->
                                    <h:outputLink value="/search.xhtml" rendered="#{SearchPage.paginationStart != 0 and SearchPage.searchResultsCount - 10 > SearchPage.paginationStart - 10}">
                                        <f:param name="q" value="#{SearchPage.query}"/>
                                        <f:param name="start" value="#{SearchPage.paginationStart - 10}"/>
                                        <c:forEach items="#{SearchPage.filterQueries}" var="clickedFilterQuery" varStatus="status">
                                            <f:param name="fq#{status.index}" value='#{clickedFilterQuery}' disable="#{clickedFilterQuery == facetLabel.filterQuery}"/>
                                        </c:forEach>
                                        <h:outputText value="Previous"/>
                                    </h:outputLink>
                                    <!--<h:outputLink value="/search.xhtml" disabled="#{SearchPage.paginationStart + 10 >= SearchPage.searchResultsCount}">-->
                                    <h:outputLink value="/search.xhtml" rendered="#{SearchPage.searchResultsCount - 10 > SearchPage.paginationStart}">
                                        <f:param name="q" value="#{SearchPage.query}"/>
                                        <f:param name="start" value="#{SearchPage.paginationStart + 10}"/>
                                        <c:forEach items="#{SearchPage.filterQueries}" var="clickedFilterQuery" varStatus="status">
                                            <f:param name="fq#{status.index}" value='#{clickedFilterQuery}' disable="#{clickedFilterQuery == facetLabel.filterQuery}"/>
                                        </c:forEach>
                                        <h:outputText value="Next"/>
                                    </h:outputLink>
                                </div>
                            </div>
                        </div>
                    </p:panel>  
                </h:form>
            </ui:define>
        </ui:composition>                
    </h:body> 
</html> 
